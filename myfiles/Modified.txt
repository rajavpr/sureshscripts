#region Running on Snapshot
$RunSnap={
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)RunSnap.log" -value "INFORMATION, $(Get-Date) Starting RunSnap test."
 #   $dmzServers |ForEach-Object{
 #       try{
 #           $srv = $_
 #           Connect-VIServer –Server $srv -Credential $credentials –Protocol https -ea stop
 #       }catch{
 #           Add-Content -path "$($tempPath)RunSnap.log" -value "ERROR, $(Get-Date) RunSnap $srv error: $($_.exception.message)"
 #      }
 #   }    
    $dteDaysAgo = (Get-Date).AddDays(-14)
    $SnapReport = @()
    
    Foreach ($vcenter in $global:DefaultVIServers ){
        try{
            Add-Content -path "$($tempPath)RunSnap.log" -value "INFORMATION, $(Get-Date) Processing vCenter: $($vcenter.name)"
            
            # Get all VMs with snapshots in one query for better performance
            $vmsWithSnapshots = Get-View -Server $vcenter.name -ViewType VirtualMachine -Property Name,Snapshot,Config.Template -Filter @{"Snapshot.RootSnapshotList"=".*"}
            
            Add-Content -path "$($tempPath)RunSnap.log" -value "INFORMATION, $(Get-Date) Found $($vmsWithSnapshots.Count) VMs with snapshots on $($vcenter.name)"
            
            foreach ($vmView in $vmsWithSnapshots) {
                [string]$vmname = $vmView.name
                
                # Skip templates
                if ($vmView.Config.Template -eq $true) {
                    continue
                }
                
                try {
                    # Get VM object and snapshots
                    $vm = Get-VM -Id $vmView.MoRef -Server $vcenter.name -ErrorAction Stop
                    $snapshots = Get-Snapshot -VM $vm -ErrorAction Stop | Where-Object {
                        ($_.Created.ToLocalTime() -lt $dteDaysAgo) -or ($_.Sizemb -gt 20000)
                    }
                    
                    foreach ($snapshot in $snapshots) {
                        # Skip excluded snapshots based on naming patterns
                        if (($snapshot.Description -like "*RPData PointTime*") -or 
                            ($vmname -like "ILVDI*") -or 
                            ($vmname -like "ILGLD*") -or 
                            ($vmname -like "*_replica") -or 
                            (($vmname -like "Win7-MasterImage*") -and ($vcenter.name -eq "ilvcvdi01.teva.corp")) -or 
                            ([string]$snapshot.Name -like "Restore Point ??-??-???? ??.??.??") -or 
                            ([string]$snapshot.Name -like "__GX_BACKUP__") -or 
                            (($vmname -like "replica-*-*-*-*-*") -and ($vcenter.name -eq "ilvcvdi01.teva.corp")) -or 
                            ($vmname -like "Template-Win7pro") -or 
                            (($vmname -like "ilgpictxmaster") -and ($vcenter.name -eq "ptvvc01.il.teva.corp")) -or 
                            ($vmname -like "sc-*") -or 
                            ($vmname -like "USGLD*")) {
                            continue
                        }
                        
                        # Get snapshot creator - Updated for vCenter 8
                        $createdBy = "Unknown"
                        try {
                            # Try to get the snapshot creation event with extended time window
                            $startTime = $snapshot.Created.AddMinutes(-5)
                            $endTime = $snapshot.Created.AddMinutes(5)
                            
                            # vCenter 8 compatible event query
                            $snapevent = Get-VIEvent -Entity $vm -Start $startTime -Finish $endTime -MaxSamples 100 -ErrorAction SilentlyContinue | 
                                Where-Object { 
                                    ($_.FullFormattedMessage -imatch 'createSnapshot') -or 
                                    ($_.FullFormattedMessage -imatch 'Create virtual machine snapshot') -or
                                    ($_.GetType().Name -eq 'TaskEvent' -and $_.Info.DescriptionId -match 'VirtualMachine.createSnapshot')
                                } | 
                                Select-Object -First 1
                            
                            if ($snapevent) {
                                $createdBy = $snapevent.UserName
                            }
                        }
                        catch {
                            Add-Content -path "$($tempPath)RunSnap.log" -value "WARNING, $(Get-Date) Could not retrieve event for snapshot $($snapshot.Name) on VM $vmname : $($_.exception.message)"
                        }
                        
                        # Create report row
                        $row = [PSCustomObject]@{
                            vCenter          = $vcenter.Name
                            VirtualMachine   = $vmname
                            SnapshotName     = [string]$snapshot.Name
                            Description      = $snapshot.Description
                            SnapshotCreated  = $snapshot.Created
                            SizeMB           = "{0:N1}" -f $snapshot.Sizemb
                            CreatedBy        = $createdBy
                        }
                        $SnapReport += $row
                    }
                }
                catch {
                    Add-Content -path "$($tempPath)RunSnap.log" -value "WARNING, $(Get-Date) Error processing VM $vmname : $($_.exception.message)"
                }
            }
        }
        catch {
            Add-Content -path "$($tempPath)RunSnap.log" -value "ERROR, $(Get-Date) RunSnap $($vcenter.name) error: $($_.exception.message)"
        }
    }
    
    # Generate HTML report
    $SnapReport = $SnapReport | Sort-Object SnapshotCreated | ConvertTo-Html -Fragment
    $mycheder1 = "<p style=`"background-color:#4E8DC2;`"><b>Snapshots Older than 14 Days or larger than 20GB</b></p> `n"
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $totalSnapshots = '<p Style="font-family:Calibri">Total Snapshots Found: ' + $SnapReport.Count + '<br></p>'
    $SnapReport = $mycheder1 + $query_time + $totalSnapshots + $SnapReport + " `n "
    $SnapReport | Out-File "$($tempPath)05.snapreport.txt" -Force 
    Add-Content -path "$($tempPath)RunSnap.log" -value "INFORMATION, $(Get-Date) Finished RunSnap test. Total snapshots reported: $($SnapReport.Count)"
}
#endregion
