################################################################################################
### This script check health parameters or non-valid parameters or settings
### on vCenters and sends report by mail on html format 
################################################################################################
#
# Parameter help description
param (
    [string]$branch_name
)
function switch_to_master_branch($branch_name){
    if($branch_name -like $null) {
        $branch_name = "master"
    }
    git checkout $branch_name
    $branch_name | Out-File "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\tempIL\branch.log" -Append
}

switch_to_master_branch -branch_name $branch_name

#region Variables
$StartTimeMS = Get-Date -DisplayHint Time #Start Chrono
$tempPath = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\tempIL\"
#$rootPath = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\"
$ZertoGlobaServersList = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\ILZertoGlobaServersList.txt"
$vROPsList = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\vROPS_List.txt"
$vcentersFile = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\vCentersList_IL.txt"

$parameters = {
    $tempPath = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\tempIL\"
    $rootPath = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\"
    $vcentersFile = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\vCentersList_IL.txt"
    $dmzServers = @("ilshovcext.teva.extdmz","ilptvvcext.teva.extdmz")
    $ZertoCreds = Import-Clixml "F:\Scripts\GlobalCreds\admzerto"
    $ZertoGlobaServersList = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\ILZertoGlobaServersList.txt"
    $vROPsList = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\vROPS_List.txt"
    $PSCs_NEW = "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\PSCs_IL_NEW.txt"
    $vCentersDetails = @{
        'ilcitrixvc01.teva.corp' = "vsphered_prod_vcsa_admin"
        'ilvcenter01.teva.corp' = "vsphered_prod_vcsa_admin"
        'ilvcenter02.teva.corp' = "vsphered_prod_vcsa_admin"
        'ilvcenter03.teva.corp' = "vsphered_prod_vcsa_admin"
        'ilvcenter01t.teva.corp' = "vsphered_prod_vcsa_admin"
        'ilvcenter02t.teva.corp' = "vsphered_prod_vcsa_admin"
        'ilvcfmngvc01.teva.corp' = "vsphered_vcf_vcsa_admin"
        'ilvcfwdvc01.teva.corp' = "vsphered_vcf_vcsa_admin"
        'ilvcfmngvc01t.teva.corp' = "vsphered_vcf_vcsa_admin"
        'ilvcfwdvc01t.teva.corp' = "vsphered_vcf_vcsa_admin"
    }
}
#endregion

#region Connect
$connect = {
#$extdmz_credentials = Import-Clixml F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\admvmwarescriptsdmz
    [System.Collections.ArrayList]$vCenters_list = Get-Content -Path $vcentersFile
    $cred = Import-Clixml "F:\Scripts\Check_VMWare_vCenters_Health\glvirtualization_health_check\admvmwarescripts"
    Set-PowerCLIConfiguration -Scope Session -DefaultVIServerMode:Multiple -Confirm:$false -InvalidCertificateAction:Ignore -ParticipateInCeip:$false    
    Foreach ($vCenter in $vCenters_list){
        if ($global:DefaultVIServers.Name -eq $vcenter) {
            continue
        } else {
            try{
                $connectivity = Test-NetConnection -ComputerName $vCenter -Port 443
                if ($connectivity.TcpTestSucceeded){
                    if ($vCenter.Contains('extdmz'))
                    {
                        Connect-VIServer -Server $vCenter -Protocol https -ea stop -Credential $extdmz_credentials
                    }
                    else
                    {
                        Connect-VIServer -Server $vCenter -Protocol https -ea stop -Credential $cred
                    }
                    #Force to get descriptive messages in English
                    #$si = get-view ServiceInstance
                    #$sm = Get-View $si.Content.SessionManager
                    #$sm.SetLocale("en_US")
                }
                else{
                    Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) cannot connect to vCenter $vcenter"
                }
            }catch{
                $ErrorMessage = $_.Exception.Message 
                Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) cannot connect to vCenter $vcenter error: $ErrorMessage"
            }
        }
    }
}
#endregion 

<#
#region SSH
$ssh={
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)ssh.log" -value "INFORMATION, $(Get-Date) Starting SSH test."	
	$VMH = Get-Cluster | Get-VMHost |
	where-Object -Property Manufacturer -notlike "Nutanix" |
	where-Object -property Name -notlike "ilvcfesx*.teva.corp" |
	where-Object -property Name -notlike "ilvcfmngesx*.teva.corp" |
	Sort-Object Name
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Open SSH Check</b></p> `n"
    $sshs = $vmh | Get-VMHostService  | Where-Object {($_.Key -eq "TSM-ssh") -and ($_.Running -eq $True)} | Select-Object vmhost,running | convertto-html -fragment
    $sshs = $sshs |ForEach-Object{
        $_ -replace "<td>True</td>","<td style=`"color: RED`">True</td>"  
    }
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $sshs = $mycheder1 + $query_time + $sshs + " `n "
    $sshs | Out-File $("$($tempPath)sshs.txt") -Force 
    Add-Content -path "$($tempPath)ssh.log" -value "INFORMATION, $(Get-Date) Finished SSH test."
}
#endregion
#>

#region Running on Snapshot
$RunSnap={
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)RunSnap.log" -value "INFORMATION, $(Get-Date) Starting RunSnap test."
 #   $dmzServers |ForEach-Object{
 #       try{
 #           $srv = $_
 #           Connect-VIServer –Server $srv -Credential $credentials –Protocol https -ea stop
 #       }catch{
 #           Add-Content -path "$($tempPath)RunSnap.log" -value "ERROR, $(Get-Date) RunSnap $srv error: $($_.exception.message)"
 #      }
 #   }    
    $dteDaysAgo = (Get-Date).AddDays(-14)
    $SnapReport = @()
    Foreach ($vcenter in $global:DefaultVIServers ){
        try{
            Get-View -Server $vcenter.name -ViewType VirtualMachine -Property Name,Snapshot,config | foreach-object {
            [string]$vmname=$_.name
            if ($_.config.template -ne $true  -and $_.Snapshot -ne $null) {
            Get-VM -Id $_.MoRef | Get-Snapshot| Where-Object{($_.Created.ToLocalTime() -lt $dteDaysAgo) -or ($_.Sizemb -gt 20000) }  | 
                ForEach-Object{
                    $snapevent = Get-VIEvent -Entity $_.VM -Types Info -Finish $_.Created -MaxSamples 1 | Where-Object {$_.FullFormattedMessage -imatch 'Task: VirtualMachine.createSnapshot'}
                    if ($snapevent -eq $null){
                        $snapevent = Get-VIEvent -Entity $_.VM -Types Info -Finish $_.Created -MaxSamples 1 | Where-Object {$_.FullFormattedMessage -imatch 'Task: Create virtual machine snapshot'}}
                        if (-not (($_.Description -like "*RPData PointTime*") -or ($vmname -like "ILVDI*") -or ($vmname -like "ILGLD*") -or ($vmname -like "*_replica") -or (($vmname -like "Win7-MasterImage*") -and ($vcenter.name -eq "ilvcvdi01.teva.corp")) -or ([string]$_.Name -like "Restore Point ??-??-???? ??.??.??") -or ([string]$_.Name -like "__GX_BACKUP__") -or (($vmname -like "replica-*-*-*-*-*") -and ($vcenter.name -eq "ilvcvdi01.teva.corp")) -or (($vmname -like "Template-Win7pro") -or (($vmname -like "ilgpictxmaster") -and ($vcenter.name -eq "ptvvc01.il.teva.corp")) -or ($vmname -like "sc-*") -or ($vmname -like "USGLD*"))))                    
                        {
                            $row = "" | Select-Object vCenter, VirtualMachine, SnapshotName, description, SnapshotCreated, sizemb, CreatedBy
                            $row.vCenter = $vcenter
			                $row.VirtualMachine = $vmname
                            $row.SnapshotName = [string]$_.Name
			                $row.description=$_.description
                            $row.SnapshotCreated = $_.Created
			                $row.sizemb= "{0:N1}" -f $_.sizemb
			                $row.CreatedBy = $snapevent.UserName
                            $SnapReport += $row 
                        }
                    }
                }
            }
        }catch{
            Add-Content -path "$($tempPath)RunSnap.log" -value "ERROR, $(Get-Date) RunSnap $($vcenter.name) error: $($_.exception.message)"
        }
    }
    $SnapReport  = $SnapReport | Sort-Object SnapshotCreated |  convertto-html -fragment
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Snapshots Older than 14 Days or larger than 20gB</b></p> `n"
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $SnapReport = $mycheder1 + $query_time + $SnapReport  + " `n "
    $SnapReport | Out-File "$($tempPath)05.snapreport.txt" -Force 
    Add-Content -path "$($tempPath)RunSnap.log" -value "INFORMATION, $(Get-Date) Finished RunSnap test."
}
#endregion

#region Host not Responding
$hostReport = {
    $StartTimeMS = Get-Date -DisplayHint Time
    $disconnectedHosts=@()
    $VMHosts = Get-VMHost
    $view = $VMHosts | Get-View
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Hosts not responding</b></p> `n"
    $hostmmReport = $VMHost | Where-Object{(($_.ConnectionState -ne "Maintenance")-and($_.ConnectionState -ne "connected"))}
    if ($null -eq $hostmmReport) {
        $NotRespondingHosts = "All ESXi hosts are connected"
        $FinalReport = $mycheder1 + $NotRespondingHosts  + " `n "
    } else {
        foreach ($vmhost in $VMHosts) {
            $vCenter_IP = $view.Summary.ManagementServerIp[0]
            $vCenter_FQDN = [System.Net.Dns]::GetHostEntry($vCenter_IP).HostName
            $custom_object = new-object PSObject
            $custom_object | add-member -MemberType NoteProperty -name 'vCenter' -Value $vCenter_FQDN
            $custom_object | add-member -MemberType NoteProperty -name 'ESXi_Host_Name' -Value $vmhost.name
            $custom_object | add-member -MemberType NoteProperty -name 'ESXi_Connection_State' -Value $vmhost.ConnectionState
            $disconnectedHosts += $custom_object
        }
        $disconnectedHosts = $disconnectedHosts | ConvertTo-Html -Fragment
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $mycheder1 + $query_time + $disconnectedHosts  + " `n "
        $FinalReport| Out-File "$($tempPath)disconnectedHosts.txt" -Force
    }
    Add-Content -path "$($tempPath)disconnectedHosts.log" -value "INFORMATION, $(Get-Date) Finished disconnectedHosts test."
}
#endregion

<#
#region High Availability and Distributed Resource Scheduling
$clusterHadrs = {
    $FilteredHADRS = ("Prod-RDM-Med1","Prod-RDM-DA", "Test-Nutanix-A","UCS SAP N20","Citrix_NEW")
    Set-Content -path "$($tempPath)ClusterHADRS.log" -value "INFORMATION, $(Get-Date) Starting ClusterHADRS test."
    $Clusters = Get-Cluster | Where-Object -Property Name -notin $FilteredHADRS | Sort-Object Name
    $Clusters = $Clusters | Select-Object @{n="vCenter"; e={($_.uid.split("@")[1]).split(":")[0] }},Name, HAEnabled, DrsEnabled,DrsAutomationLevel
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>DRS and HA Check</b></p> `n"
    $dreport =$Clusters | Where-Object {($_.HAEnabled -ne $true) -or ($_.DrsEnabled -ne $true) -or ($_.DrsAutomationLevel -ne "FullyAutomated")} | convertto-html vCenter,Name,HAEnabled,DrsEnabled,DrsAutomationLevel -fragment
    $dreport = $dreport | foreach {
        $_ -replace "<td>False</td>","<td style=`"color: RED`">False</td>"
    }
    $dreport = $mycheder1 + $dreport  + " `n "
    $dreport | Out-File "$($tempPath)clusterhadrs.txt" -Force
    Add-Content -path "$($tempPath)ClusterHADRS.log" -value "INFORMATION, $(Get-Date) Finished ClusterHADRS test."
}
#endregion
#>

<#
#region Duplicated MAC addresses
$duplicateMAC = {
    Set-Content -path "$($tempPath)DuplicateMAC.log" -value "INFORMATION, $(Get-Date) Starting DuplicateMAC test."
    $macTab = @{}
    #$Count=0 #TODO: delete variable
    $machtml="<table>
    <colgroup>
    <col/>
    </colgroup>
    <tr><th>Duplicated MAC</th></tr> `n"
    try {
        $VMSTable=Get-View -ViewType VirtualMachine -Property Name,config -ea Stop

        $VMSTable | ForEach-Object {
        if ($_.config.template -ne $true)
        {
            #Get info for current VM
            $vmname = $_.name
            $vmnamevc = $_.client.serviceurl.split("/")[2]

            #Check if it's duplicated and show
            $_.Config.Hardware.Device | Where-Object {$_.MacAddress -ne $null}| ForEach-Object {
                if($macTab.ContainsKey($_.MacAddress)){

                    $dstvm=$macTab[$_.MacAddress]
                    $curmac=$_.MacAddress

                    $dstvmvcobj= $VMSTable | where-object {($_.name -eq $dstvm)}
                    $dstvmvc = $dstvmvcobj.client.serviceurl.split("/")[2] #Convert the object to string

                    $htmlnewline="<tr><td>Duplicate MAC address $curmac in $vmname at $vmnamevc and $dstvm at $dstvmvc</td></tr>"

                    $machtml="$machtml $htmlnewline `n "
               }else{
                   #This fills the table with the Mac's information on first iteration
                        $macTab[$_.MacAddress] = $vmname
                    }
                }
            }
        }
    }catch{
        Add-Content -path "$($tempPath)DuplicateMAC.log" -value "ERROR, $(Get-Date) error: $($_.exception.message)"
    }
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Duplicated MAC</b></p> `n "
    $machtml=$mycheder1 +"$machtml `n " + "</table>" 
    $machtml | Out-File "$($tempPath)dupmac.txt" -Force
    Add-Content -path "$($tempPath)DuplicateMAC.log" -value "INFORMATION, $(Get-Date) Finished DuplicateMAC test."
}
#endregion
#>

#region Invalid VMS
$invalidvms = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)Invalidvms.log" -value "INFORMATION, $(Get-Date) Starting InvalidVMs"
    #$macTab = @{} #TODO: delete
    #$Count=0 #TODO: delete
    $invalhtml="<table>
    <colgroup>
    <col/>
    </colgroup>
    <tr><th>VM Name</th><th>VMHost</th><th>vCenter</th></tr> `n"
    try{
        $myinvalidvms=(Get-View -ViewType VirtualMachine -Filter @{"Runtime.ConnectionState"="invalid"} -ea Stop) 
        $myinaccessible=(Get-View -ViewType VirtualMachine -Filter @{"Runtime.ConnectionState"="inaccessible"} -ea Stop) 
    }catch{
        Add-Content -path "$($tempPath)Invalidvms.log" -value "ERROR, $(Get-Date) error: $($_.exception.message)"
    }
    $allerrvms=(($myinvalidvms+$myinaccessible)  ) | ForEach-Object{$_.MoRef.ToString()}| Select-Object -Unique
    $allerrvms | ForEach-Object{
        $myvmname=$_
        $v = get-vm -id $myvmname
        $htmlnewline="<tr><td>$myvmname</td><td>$($v.VMHost)</td><td>$( ($v.Uid.split("@")[1]).split(":")[0] )</td></tr>"
        $invalhtml="$invalhtml $htmlnewline `n "	   
    } 
    $mycheder2="<p style=`"background-color:#4E8DC2;`"><b>Invalid VM's</b></p> `n "
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $invalhtml=$mycheder2 + $query_time + "$invalhtml `n " + "</table>" 
    $invalhtml | Out-File "$($tempPath)invalidvms.txt" -Force
    Add-Content -path "$($tempPath)Invalidvms.log" -value "INFORMATION, $(Get-Date) Finished InvalidVMs"
}
#endregion

#region VMs Limited Resources
<#
$vmsWithLimit = {
    Set-Content -path "$($tempPath)VMsWithLimit.log" -value "INFORMATION, $(Get-Date) Starting VMsWithLimit"
    $limitandreservations = @()
    #$Count=0 #TODO: delete
    $machtml="<table>
    <colgroup>
    <col/>
    </colgroup>
    <tr><th>VM's with memory Limit</th></tr> `n"
    try{
        get-view -ViewType virtualmachine -Property name,Config.MemoryAllocation.Limit,Config.CpuAllocation.Limit,Config.MemoryAllocation.Reservation,Config.CpuAllocation.Reservation -ea Stop| Where-Object{(($_.Config.MemoryAllocation.Limit -ne "-1")-or ($_.Config.CpuAllocation.Limit -ne "-1"   )-or ($_.Config.MemoryAllocation.Reservation -ne "0"   )-or ($_.Config.CpuAllocation.Reservation -ne "0"   ))} | ForEach-Object{
            if ($_.name -notlike '*CVM' -and $_.name -notlike "Z-VRA*" -and $_.name -notlike "ilorionapp01" -and $_.name -notlike "*NSX-controller*" -and $_.name -notlike "*NSXT-controller*" -and $_.name -notlike "*ilvcf*") {
                $myvm=$_.name
                if($_.Config.MemoryAllocation.Limit -eq "-1"){
                    $mymemlim =$false
                }else{
                    $mymemlim =$true 
                }
                if($_.Config.CpuAllocation.Limit -eq "-1"){
                    $cpulim =$false
                }else{
                    $cpulim =$true 
                }

                if($_.Config.MemoryAllocation.Reservation -eq "0"){
                    $memres =$false
                }else{
                    $memres =$true 
                }
                if($_.Config.cpuAllocation.Reservation -eq "0"){
                    $cpures =$false
                }else{
                    $cpures =$true 
                }
                $row = "" | Select-Object VirtualMachine, memlimit, cpulimit ,cpureservation, memreservation
                $row.VirtualMachine = $myvm
                $row.memlimit = $mymemlim
                $row.cpulimit = $cpulim
                $row.cpureservation= $cpures 
                $row.memreservation = $memres 
                $limitandreservations += $row    
            }
        }
    }catch{
        Add-Content -path "$($tempPath)VMsWithLimit.log" -value "ERROR, $(Get-Date) error: $($_.exception.message)"
    }
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>VM's with Limit and Reservation</b></p> `n "
    $limitandreservations  = $limitandreservations | Sort-Object -property VirtualMachine | convertto-html -fragment
    $limitandreservations = $mycheder1 + $limitandreservations  + " `n "
    $limitandreservations = $limitandreservations | ForEach-Object {
        $_ -replace "<td>True</td>","<td style=`"color: RED`">True</td>"
    }
    $limitandreservations | Out-File "$($tempPath)vmsmemlimit.txt" -Force
    Add-Content -path "$($tempPath)VMsWithLimit.log" -value "INFORMATION, $(Get-Date) Finished VMsWithLimit"
}
#>
#endregion

#region vCenters VCSA Backups Status for the last 2 days
$VCSABackupsStatus = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)VCSABackupsStatus.log" -value "INFORMATION, $(Get-Date) Starting VCSABackupsStatus"
    $VCSABackupsReport = @()
    foreach ($vcenter in $global:DefaultVIServers){
        [version]$VCSAVersion = $vCenter.Version
        [version]$version = "6.5.0"
        $backupsRow = $null
        $backups = $null        
        $array = New-Object -TypeName PSObject
        $array | Add-Member -Force -MemberType NoteProperty -Name "vCenter_Name" -Value "<a href='https://$($vcenter):5480'>$vcenter</a>"
        try {
            $isvCenterLinux = $vCenter.ExtensionData.Content.About.OsType -like '*linux*' #if VC is not windows, will use REST API
        }
        catch {
            $isvCenterLinux = $null
            $ErrorMessage = $_.Exception.Message
            Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . VCSABackupsStatus: vCenter $vcenter is not Linux" $ErrorMessage
        }
        
        if (($VCSAVersion -ge $version) -and $isvCenterLinux) {
            $vCenterAuthenticationAPI = "/rest/com/vmware/cis/session"
            $vCenterServicesAPI = "/rest/appliance/recovery/backup/job"
            $vCenterJobStatusAPI = "/rest/appliance/recovery/backup/job/"
            ################################################
            # Setting Cert Policy - required for successful auth with the Zerto API without connecting to vsphere using PowerCLI
            ################################################
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
            add-type @"
            using System.Net;
            using System.Security.Cryptography.X509Certificates;
            public class TrustAllCertsPolicy : ICertificatePolicy {
                public bool CheckValidationResult(
                ServicePoint srvPoint, X509Certificate certificate,
                WebRequest request, int certificateProblem) {
                return true;
                }
            }
"@
            [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy -ErrorAction SilentlyContinue
            ################################################
            # Building vCenter API string and invoking API
            ################################################
            $cred = $null
            # $i = 5       
            # Do {
            #     #Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . CyberArkPAM: failed to get credentials from PAM. Trying again"
            #     Write-Host $i
            #     Start-Sleep 10
            #     $cred = CyberArkPAM -AccountID $vCentersDetails.($vCenter.Name)
            #     $i--
            # } While (($cred -eq $null) -and ($i -gt 0))
            $cred = CyberArkPAM -AccountID $vCentersDetails.($vCenter.Name)
            if ($cred) {
                $vCenterSSOUsername = "administrator@vsphere.local"
                $AuthInfo = ("{0}:{1}" -f $vCenterSSOUsername, $cred.password)
                $BaseURL = "https://" + $vCenter.Name
                $AuthenticationURL = $BaseURL + $vCenterAuthenticationAPI
                $ServicesURL = $BaseURL + $vCenterServicesAPI
                $vCenterJobStatusURL = $BaseURL + $vCenterJobStatusAPI
                $AuthInfo = [System.Text.Encoding]::UTF8.GetBytes($AuthInfo)
                $AuthInfo = [System.Convert]::ToBase64String($AuthInfo)
                $Headers = @{Authorization=("Basic {0}" -f $AuthInfo)}
                #$TypeJSON = "application/JSON"
                #$TypeXML = "application/XML"

                Try
                {
                    $vCenterSessionResponse = Invoke-WebRequest -Uri $AuthenticationURL -Method Post -Headers $Headers
                    $token = (ConvertFrom-Json $vCenterSessionResponse.Content).value
                    $session = @{'vmware-api-session-id' = $token}
                }
                Catch {
                    $ErrorMessage = $_.Exception.Message
                    Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . VCSABackupsStatus: vCenter $vcenter failed to get token. $ErrorMessage"
                }
                if ($session.Values)
                {
                    try
                    {
                        $backupsRow = Invoke-WebRequest -Uri $ServicesURL -Method get -Headers $session
                        $backups = (ConvertFrom-Json $backupsRow).value | Where-Object {$_ -like ((get-date).AddDays(-2).ToString("yyyyMMdd*"))}
                    }
                    catch 
                    {
                        $ErrorMessage = $_.Exception.Message
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . VCSABackupsStatus: vCenter $vcenter failed to get backups. $ErrorMessage"
                    }
                    if ($null -ne $backups) {
                        try {
                            $backupStatus = Invoke-RestMethod -Uri ($vCenterJobStatusURL + $backups) -Method get -Headers $session
                            $array | Add-Member -Force -MemberType NoteProperty -Name "Last_Backup" -Value $backupStatus.value.state
                        }
                        catch {
                            $ErrorMessage = $_.Exception.Message
                            Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . VCSABackupsStatus: Failed to get backup status from REST API query. $ErrorMessage"
                        }
                    } else {
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Last_Backup" -Value ("The last backup was at " + ((ConvertFrom-Json $backupsRow).value | Select-Object -First 1))
                    }
                    $VCSABackupsReport += $array
                } else {
                    continue
                }
            } else {
                Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . VCSABackupsStatus: vCenter $vcenter failed to get credentials from PAM."
            }
        }
            
    }
    $VCSABackupsFinalReport = $VCSABackupsReport
    $header="<p style=`"background-color:#4E8DC2;`"><b>vCenters VCSA Backups Status for the last 2 days</b></p> `n"
    $VCSABackupsReportHTML = $VCSABackupsFinalReport | ConvertTo-Html -fragment
    $VCSABackupsReportHTML = $VCSABackupsReportHTML -replace "<td>SUCCEEDED</td>", '<td bgcolor="Green">SUCCEEDED</td>'
    $VCSABackupsReportHTML = $VCSABackupsReportHTML -replace "<td>FAILED</td>", '<td bgcolor="Red">FAILED</td>'
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $VCSABackupsStatusHTML = $header + $query_time + $VCSABackupsReportHTML + " `n "
    [System.Web.HttpUtility]::HtmlDecode($VCSABackupsStatusHTML) |  Out-File "$($tempPath)01.VCSABackupsStatus.txt" -Force
    Add-Content -path "$($tempPath)VCSABackupsStatus.log" -value "INFORMATION, $(Get-Date) Finished VCSABackupsStatus"
}
#endregion

#region vCenter Appliance Services status
$serviceStatus = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)serviceStatus.log" -value "INFORMATION, $(Get-Date) Starting serviceStatus"
    $report = @()
    $VCSAreport = @()
    $VCSAServersWithoutProblems = @()
    foreach ($vcenter in $global:DefaultVIServers){
        [version]$VCSAVersion = $vCenter.Version
        [version]$version = "6.5.0"
        try {
            $isvCenterLinux = $vCenter.ExtensionData.Content.About.OsType -like '*linux*' #if VC is not windows, will use REST API
        }
        catch {
            $isvCenterLinux = $null
        }
        
        if (($VCSAVersion -ge $version) -and $isvCenterLinux) {
            $vCenterAuthenticationAPI = "/rest/com/vmware/cis/session"
            $vCenterServicesAPI = "/rest/vcenter/services"

            ################################################
            # Setting Cert Policy - required for successful auth with the Zerto API without connecting to vsphere using PowerCLI
            ################################################
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
            add-type @"
             using System.Net;
             using System.Security.Cryptography.X509Certificates;
             public class TrustAllCertsPolicy : ICertificatePolicy {
             public bool CheckValidationResult(
             ServicePoint srvPoint, X509Certificate certificate,
             WebRequest request, int certificateProblem) {
             return true;
             }
             }
"@
            [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy -ErrorAction SilentlyContinue
            ################################################
            # Building vCenter API string and invoking API
            ################################################
            $cred = $null
            # $i = 5
            # Do {
            #     #Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . serviceStatus: failed to get credentials from PAM. Trying again"
            #     Write-Host $i
            #     Start-Sleep 10
            #     $cred = CyberArkPAM -AccountID $vCentersDetails.($vCenter.Name)

            #     $i--
            # } While (($cred -eq $null) -and ($i -gt 0))
            $cred = CyberArkPAM -AccountID $vCentersDetails.($vCenter.Name)
            if ($cred) {
                $vCenterSSOUsername = "administrator@vsphere.local"
                $AuthInfo = ("{0}:{1}" -f $vCenterSSOUsername, $cred.password)
                $AuthInfo
                $BaseURL = "https://" + $vcenter.name
                $AuthenticationURL = $BaseURL + $vCenterAuthenticationAPI
                $ServicesURL = $BaseURL + $vCenterServicesAPI
                $AuthInfo = [System.Text.Encoding]::UTF8.GetBytes($AuthInfo)
                $AuthInfo = [System.Convert]::ToBase64String($AuthInfo)
                $Headers = @{Authorization=("Basic {0}" -f $AuthInfo)}
                #$TypeJSON = "application/JSON"
                #$TypeXML = "application/XML"

                Try
                {
                    $vCenterSessionResponse = Invoke-WebRequest -Uri $AuthenticationURL -Method Post -Headers $Headers
                    $token = (ConvertFrom-Json $vCenterSessionResponse.Content).value
                    $session = @{'vmware-api-session-id' = $token}
                }
                Catch {
                    Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . serviceStatus: vCenter $vcenter : failed to get token"
                }

                if ($session.Values)
                {
                    try
                    {
                        $servicesRow = Invoke-WebRequest -Uri $ServicesURL -Method get -Headers $session
                        $services = ((ConvertFrom-Json $servicesRow.Content).value).value | Where-Object{$_.startup_type -eq 'AUTOMATIC'}
                        $array = New-Object -TypeName PSObject
                        foreach ($service in $services)
                        {
                            if (($service.state -eq 'STARTED') -and ($service.health -eq 'HEALTHY'))
                            {
                                continue
                            }
                            else
                            {                           
                                $array | Add-Member -Force -MemberType NoteProperty -Name "vCenter_Name" -Value $vcenter.name
                                $array | Add-Member -Force -MemberType NoteProperty -Name "Service_Name" -Value $service.name_key.Substring(0, $service.name_key.lastIndexOf('.'))
                                $array | Add-Member -Force -MemberType NoteProperty -Name "Service_State" -Value $service.state
                                $array | Add-Member -Force -MemberType NoteProperty -Name "Service_Health" -Value $service.health
                                if ($service.health_messages.count -ne 0) {
                                    $array | Add-Member -Force -MemberType NoteProperty -Name "Service_Health_Messages" -Value ($service.health_messages.default_message -join ' | ')
                                }
                                $VCSAreport += $array
                            }
                        }
                        # if all servers are run and healthy                   
                        if (($VCSAreport.Count -eq 0) -or (!$VCSAreport.vCenter_Name.contains($vCenter.name))) {
                            $array | Add-Member -Force -MemberType NoteProperty -Name "vCenter_Name" -Value $vcenter.name
                            $array | Add-Member -Force -MemberType NoteProperty -Name "Global_Status" -Value "All services are running and healthy."
                            $VCSAServersWithoutProblems += $array
                        }
                    }
                    catch 
                    {
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . serviceStatus: vCenter $vcenter : failed to get services status. error: $($_.Exception.Message)"
                    }
                }
            } else {
                Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . serviceStatus: vCenter $vcenter failed to get credentials from PAM."
            }

        } else {
            $VirtualCenterServer = $null
            $Management = $null
            $vCenterInventory = $null
            $LANvspherewebclientsvc = $null
            $LANinvsvc = $null
            try{
                $VirtualCenterServer = (Get-Service -ComputerName $vcenter.name -Name vpxd).status
                $Management = (Get-Service -ComputerName $vcenter.name -Name vctomcat).status
                $vCenterInventory = (Get-Service -ComputerName $vcenter.name -Name vimQueryService).status
                $LANvspherewebclientsvc = (Get-Service -ComputerName $vcenter.name -Name vspherewebclientsvc).status
                $LANinvsvc = (Get-Service -ComputerName $vcenter.name -Name invsvc).status

                $array = New-Object -TypeName PSObject
                $array | Add-Member -Force -MemberType NoteProperty -Name "vCenter" -Value $vcenter.name
                $array | Add-Member -Force -MemberType NoteProperty -Name "VirtualCenter Server" -Value $VirtualCenterServer
                $array | Add-Member -Force -MemberType NoteProperty -Name "Management Webservices 5.x" -Value $Management
                $array | Add-Member -Force -MemberType NoteProperty -Name "vCenter Inventory 5.x" -Value $vCenterInventory
                $array | Add-Member -Force -MemberType NoteProperty -Name "VMware vSphere Web Client" -Value $LANvspherewebclientsvc
                $array | Add-Member -Force -MemberType NoteProperty -Name "vCenter Inventory 6.x" -Value $LANinvsvc
                $report += $array
            }catch{
                Add-Content -path "$($tempPath)serviceStatus.log" -value "ERROR, $(Get-Date) vcenter: $($vcenter.name) error: $($_.Exception.Message)"
            }
        }
    }
    
    # $finalReport = $report
    # $header="<p style=`"background-color:#4E8DC2;`"><b>Windows vCenter Services status</b></p> `n"
    # $reportHTML = $finalReport | ConvertTo-Html -fragment
    # $reportHTML = $reportHTML -replace "<td>Running</td>", '<td bgcolor="Green">Running</td>'
    # $reportHTML = $reportHTML -replace "<td>Stopped</td>", '<td bgcolor="Red">Stopped</td>'
    # $ServiceStatus = $header + $reportHTML + " `n "
    # $ServiceStatus | Out-File "$($tempPath)01.vCenterServiceStatusHTML.txt" -Force 
    # Add-Content -path "$($tempPath)serviceStatus.log" -value "INFORMATION, $(Get-Date) Finished serviceStatus"

    $VCSAfinalReport = ($VCSAreport | Select-Object -Unique)
    $header="<p style=`"background-color:#4E8DC2;`"><b>vCenter Appliance Services status</b></p> `n"
    $VCSAreportHTML = $VCSAfinalReport | ConvertTo-Html -fragment
    $array = New-Object -TypeName PSObject
    if ($VCSAreport.Count -eq 0) {
            
    }
    else {
        foreach ($VCSAservice in $VCSAfinalReport) {
            if ($VCSAservice.Service_Health -eq 'HEALTHY_WITH_WARNINGS') {
                $VCSAreportHTML = $VCSAreportHTML -replace "<td>HEALTHY_WITH_WARNINGS</td>", '<td bgcolor="Yellow">HEALTHY_WITH_WARNINGS</td>'
            }
            elseif ($VCSAservice.Service_State -eq 'STOPPED') {
                $VCSAreportHTML = $VCSAreportHTML -replace "<td>STOPPED</td>", '<td bgcolor="Red">STOPPED</td>'
            }
            else {               
                continue
            }
        }
    }
    $VCSAreportHTML = $VCSAreportHTML + (($VCSAServersWithoutProblems) | ConvertTo-Html -Fragment)
    $VCSAreportHTML = $VCSAreportHTML -replace "<td>All services are running and healthy.</td>", '<td bgcolor="Green">All services are running and healthy</td>'
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $VCSAServiceStatus = $header + $query_time + $VCSAreportHTML + " `n "
    $VCSAServiceStatus | Out-File "$($tempPath)02.VCSAServiceStatusHTML.txt" -Force
}
#endregion

#region SRM Services verification
$serviceStatusSRM = {
    $StartTimeMS = Get-Date -DisplayHint Time
    $srmservers_list= "ilsrmapp01.il.teva.corp", "ilsrmapp02.il.teva.corp", "ilsrmapp01t.teva.corp", "ilsrmapp02t.teva.corp" #TODO: get SRM service list to file
    Set-Content -path "$($tempPath)serviceStatusSRM.log" -value "INFORMATION, $(Get-Date) Starting SRM Service Status"
    $SRMreport = @()
    foreach ($srmserver in $srmservers_list) {
        $SRM_service=$null  #servicename VMWare-DR
        try{
            $SRM_service = (Get-Service -ComputerName $srmserver -Name vmware-dr).status
            $array = New-Object -TypeName PSObject
            $array | Add-Member -Force -MemberType NoteProperty -Name "Server" -Value $srmserver
            if ($SRM_service) {
                $array | Add-Member -Force -MemberType NoteProperty -Name "SRM Service" -Value $SRM_Service 
            } else {
                $array | Add-Member -Force -MemberType NoteProperty -Name "SRM Service" -Value "Unable to get the service status"
            }                                 
            $SRMreport += $array      
        }catch{       
            Add-Content -path "$($tempPath)serviceStatusSRM.log" -value "ERROR, $(Get-Date) vcenter: $srmserver error: $($_.Exception.Message)"     
        }
    }

    $finalReport = $SRMreport
    $header="<p style=`"background-color:#4E8DC2;`"><b>SRM Services status</b></p> `n"
    $reportHTML = $finalReport | ConvertTo-Html -fragment
    $reportHTML = $reportHTML -replace "<td>Running</td>", '<td bgcolor="Green">Running</td>'
    $reportHTML = $reportHTML -replace "<td>Stopped</td>", '<td bgcolor="Red">Stopped</td>'
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $ServiceStatus = $header + $query_time + $reportHTML + " `n "
    $ServiceStatus | Out-File "$($tempPath)02.ZertoandSRMServiceStatus.txt" -Force 
    Add-Content -path "$($tempPath)serviceStatusSRM.log" -value "INFORMATION, $(Get-Date) Finished SRM Service Status"
    
}
#endregion

#region Zerto Services verification
$serviceStatusZerto = {
    $StartTimeMS = Get-Date -DisplayHint Time
    [System.Collections.ArrayList]$Zerto_servers = Get-Content -Path $ZertoGlobaServersList
    Set-Content -path "$($tempPath)serviceStatusZerto.log" -value "INFORMATION, $(Get-Date) Starting Zerto Service Status"
    $Zertoreport = @()
    foreach ($zertoserver in $zerto_servers){
        [System.Collections.ArrayList]$services = 'ZertoEmbeddedDB','ZertoOnlineServicesConnector','ZertoVba','ZertoZvm'
        $array = New-Object -TypeName PSObject
        $array | Add-Member -Force -MemberType NoteProperty -Name 'Server_Name' -Value $zertoserver
        foreach ($service in $services) {
            try { 
                $ZertoService = (Get-Service -ComputerName $zertoserver -Name $service -ErrorAction Stop).status
                Write-Output "Service $service is installed"
                #$array | Add-Member -Force -MemberType NoteProperty -Name 'Server Name' -Value $zertoserver
                $array | Add-Member -Force -MemberType NoteProperty -Name $service -Value $ZertoService
            } catch 
            {
                if ($_.Exception.Message -like '*Cannot find any service with service name*')
                {
                    Write-Output "Service $service is not installed"
                    #$array | Add-Member -Force -MemberType NoteProperty -Name 'Server Name' -Value $zertoserver
                    $array | Add-Member -Force -MemberType NoteProperty -Name $service -Value "Service_is_not_installed"
                    Add-Content -path "$($tempPath)serviceStatusZerto.log" -value "ERROR, $(Get-Date) vcenter: $zertoserver error: $($_.Exception.Message)"
                }
            }

    
        }
        $Zertoreport += $array
    }
    
    $finalReport = $Zertoreport
    $header="<p style=`"background-color:#4E8DC2;`"><b>Zerto Services status</b></p> `n"
    $reportHTML = $finalReport | ConvertTo-Html -fragment
    $reportHTML = $reportHTML -replace "<td>Running</td>", '<td bgcolor="Green">Running</td>'
    $reportHTML = $reportHTML -replace "<td>Stopped</td>", '<td bgcolor="Red">Stopped</td>'
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $ServiceStatus = $header + $query_time + $reportHTML + " `n "
    $ServiceStatus | Out-File "$($tempPath)03.ZertoServiceStatusHTML.txt" -Force 
    Add-Content -path "$($tempPath)serviceStatusZerto.log" -value "INFORMATION, $(Get-Date) Finished Zerto Service Status"    
}
#endregion

#region Zerto VPGs status
$ZertoVPGsStatus = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)ZertoVPGsStatus.log" -value "INFORMATION, $(Get-Date) Starting ZertoVPGsStatus"
    $ZertoPort = "9669"
    $ZertoUser = $ZertoCreds.UserName
    $ZertoPassword = $ZertoCreds.GetNetworkCredential().Password
    [System.Collections.ArrayList]$ZVMs = Get-Content -Path $ZertoGlobaServersList
    $VGPsFailed = @()

    add-type @"
        using System.Net;
        using System.Security.Cryptography.X509Certificates;
        public class TrustAllCertsPolicy : ICertificatePolicy {
            public bool CheckValidationResult(
            ServicePoint srvPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
            }
        }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy -WarningAction SilentlyContinue
            
    foreach ($ZVM in $ZVMs) {
        ################################################
        # Building Zerto API string and invoking API
        ################################################
        $BaseURL = "https://" + $ZVM + ":"+$ZertoPort+"/v1/"
        # Authenticating with Zerto APIs
        $xZertoSessionURL = $BaseURL + "session/add"
        $AuthInfo = ("{0}:{1}" -f $ZertoUser,$ZertoPassword)
        $AuthInfo = [System.Text.Encoding]::UTF8.GetBytes($AuthInfo)
        $AuthInfo = [System.Convert]::ToBase64String($AuthInfo)
        $Headers = @{Authorization=("Basic {0}" -f $AuthInfo)}
        $SessionBody = '{"AuthenticationMethod": "1"}'
        $TypeJSON = "application/JSON"
        #$TypeXML = "application/XML"
        Try
        {
            $xZertoSessionResponse = Invoke-WebRequest -Uri $xZertoSessionURL -Headers $Headers -Method POST -Body $SessionBody -ContentType $TypeJSON
            $xZertoSession = $xZertoSessionResponse.headers.get_item("x-zerto-session")
            $ZertoSessionHeader = @{"x-zerto-session"=$xZertoSession}
        }
        Catch {
            $ErrorMessage = $_.Exception.Message
            Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . ZertoVPGsStatus: Failed to get x-zerto-session. $ErrorMessage"
        }
        #Extracting x-zerto-session from the response, and adding it to the actual API


        $VPGsURI = $BaseURL+"vpgs"


        if ($ZertoSessionHeader.Values)
        {
            try
            {
                $VPGs = Invoke-RestMethod -Uri $VPGsURI -TimeoutSec 100 -Headers $ZertosessionHeader -ContentType $TypeJSON
                
                foreach ($VPGStatus in $VPGs)
                {
                    if ($VPGStatus.status -eq 1)
                    {
                        continue
                    }
                    else
                    {
                        $array = New-Object -TypeName PSObject
                        $array | Add-Member -Force -MemberType NoteProperty -Name "ZVM Server" -Value $ZVM
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Source_Site_name" -Value $VPGStatus.SourceSite
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Target_Site_name" -Value $VPGStatus.TargetSite
                        $array | Add-Member -Force -MemberType NoteProperty -Name "VPG_Name" -Value $VPGStatus.VpgName
                        if ($service.health_messages.count -ne 0) {
                            $array | Add-Member -Force -MemberType NoteProperty -Name "Service_Health_Messages" -Value ($service.health_messages.default_message -join ' | ')
                        }

                        $VGPsFailed += $array
                    }
                }
            }
            catch 
            {
                $ErrorMessage = $_.Exception.Message
                Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . ZertoVPGsStatus: Failed to get VPGStatus. $ErrorMessage"
            }
        }

    }

    $header="<p style=`"background-color:#4E8DC2;`"><b>Zerto VPGs with ERRORS</b></p> `n"
    if ($VGPsFailed.Count -eq 0) {
        $VPGsFinalReport = "All VPGs are OK"
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $header + $query_time + $VPGsFinalReport + " `n "
    } else {
        $VPGsFinalReport = $VGPsFailed | ConvertTo-Html -fragment
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $header + $query_time + $VPGsFinalReport + " `n "
    }
    $FinalReport | Out-File "$($tempPath)04.ZertoVPGsStatus.txt" -Force
    Add-Content -path "$($tempPath)ZertoVPGsStatus.log" -value "INFORMATION, $(Get-Date) Finished ZertoVPGsStatus"
}
#endregion

#region Zero uptime hosts
$ZeroUptime = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)ZeroUptime.log" -value "INFORMATION, $(Get-Date) Starting ZeroUptime"
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>ESXi hosts with 0 uptime - needs restart to management agents</b></p> `n"
    $vmhostsView = (Get-View -ViewType HostSystem) | Select-Object Name,@{n="Uptime"; e={$_.Summary.QuickStats.Uptime}} | Where-Object {$_.Uptime -eq "0"}
    $ZeroUptimeHosts = $vmhostsView | Select-Object @{n="vCenter"; e={((Get-VMHost -name $_.Name).uid.split("@")[1]).split(":")[0]}},Name,Uptime
    if ($null -eq $ZeroUptimeHosts) {
        $ZeroUptimeHostsReport = "All hosts are OK"
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $mycheder1 + $query_time + $ZeroUptimeHostsReport  + " `n "
    } else {
        $prop1 = @{Expression='vCenter'; Ascending=$true }
        $prop2 = @{Expression='Name'; Ascending=$true }
        $ZeroUptimeHostsReport  = $ZeroUptimeHosts | Sort-Object $prop1,$prop2 |  convertto-html -fragment
        $FinalReport = $mycheder1 + $query_time + $ZeroUptimeHostsReport + " `n "   
    }
    $FinalReport | Out-File "$($tempPath)12.HostsUptime.txt" -Force
    Add-Content -path "$($tempPath)ZeroUptime.log" -value "INFORMATION, $(Get-Date) Finished ZeroUptime"
}
#endregion

#region Check Active Alarms on Hosts
$checkHostAlarm = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)checkHostAlarm.log" -value "INFORMATION, $(Get-Date) Starting checkHostAlarm"
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Hosts Alarms</b></p> `n"
    $AlarmHostList = @()
    Foreach ($vcenter in $global:DefaultVIServers ){
        $hosts = Get-Datacenter -Server $vcenter.name | Where-Object {$_.Name -ne "Teva Small Site"} | Get-VMHost | Get-View 	#Retrieve all hosts from vCenter
        $HostList = @()
        foreach ($esxihost in $hosts){ 														#For each Host
            foreach($triggered in $esxihost.TriggeredAlarmState){ 							#For each triggered alarm of each host
                $Reason = Get-VIEvent -Entity $esxihost.Name | Where-Object {$alarmDefinition.Info.Name -eq "Host connection and power state" -and $_.UserName -ne '' -and $_.UserName -ne 'root' -and $_.UserName -ne "VirtualCenter" -and $_.FullFormattedMessage -eq 'Task: Initiate host shutdown'} | Select-Object UserName, FullFormattedMessage
                $arrayline={} | Select-Object vCenter, HostName, AlarmType, AlarmInformations, InitiatedBy, Reason 			#Initialize line
                $alarmDefinition = Get-View -Server $vcenter.Name -Id $triggered.Alarm 						#Get info on Alarm
                $arrayline.vCenter = $vcenter.Name 
                $arrayline.HostName = $esxihost.Name 									#Get host which has this alarm triggered
                $arrayline.AlarmType = $triggered.OverallStatus 						#Get if this is a Warning or an Alert
                $arrayline.AlarmInformations = $alarmDefinition.Info.Name 				#Get infos about alarm
                $arrayline.InitiatedBy = $Reason.UserName
                $arrayline.Reason = [string]$Reason.FullFormattedMessage
                $HostList += $arrayline 												#Add line to array 	#Post-Declare this is an array which may contain more than one element
            }
        }
        $AlarmHostList += $HostList
    }
    $prop1 = @{Expression='vCenter'; Ascending=$true }
    $prop2 = @{Expression='HostName'; Ascending=$true }
    $CheckHostAlarmReport  = $AlarmHostList | Sort-Object $prop1,$prop2 | convertto-html
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $FinalReport = $mycheder1 + $query_time + $CheckHostAlarmReport 
    $FinalReport | Out-File "$($tempPath)06.CheckHostAlarm.txt" -Force
    Add-Content -path "$($tempPath)checkHostAlarm.log" -value "INFORMATION, $(Get-Date) Finished checkHostAlarm"
}
#endregion

#region Active Alarms
<#
$actionAlarmEnabled = {
    Set-Content -path "$($tempPath)actionAlarmEnabled.log" -value "INFORMATION, $(Get-Date) Starting actionAlarmEnabled"
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Alarm Action turned off</b></p> `n"
    $AlarmHostList = @()
    Foreach ($vcenter in $global:DefaultVIServers ){
        $alarmMgr = Get-View AlarmManager -Server $vcenter.Name
        $AllHosts = Get-VMHost -Server $vcenter.Name
        $vCenterAlarmHost = $AllHosts | Where-Object {($alarmMgr.AreAlarmActionsEnabled($_.Extensiondata.MoRef)) -eq $False} | Select-Object @{n="vCenter"; e={$vcenter.Name}}, Parent, Name,  @{n="Alarm Status"; e={$alarmMgr.AreAlarmActionsEnabled($_.Extensiondata.MoRef)}}
        $AlarmHostList += $vCenterAlarmHost
    }
    $prop1 = @{Expression='vCenter'; Ascending=$true }
    $prop2 = @{Expression='Parent'; Ascending=$true }
    $ActionAlarmEnabledReport  = $AlarmHostList | Sort-Object $prop1,$prop2 |  convertto-html -fragment
    $FinalReport = $mycheder1 + $ActionAlarmEnabledReport  + " `n "
    $FinalReport | Out-File "$($tempPath)06.ActionAlarmEnabled.txt" -Force
    Add-Content -path "$($tempPath)actionAlarmEnabled.log" -value "INFORMATION, $(Get-Date) Finished actionAlarmEnabled"
}
#endregion
#>
#region SD Failures
$SDReport = {
    Set-Content -path "$($tempPath)SDReport.log" -value "INFORMATION, $(Get-Date) Starting SDReport"
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Hosts That had SD errors in the last 48 Hours</b></p> `n"
    $vCenterAlarmHost = Get-VMHost | Select-Object @{n="vCenter"; e={($_.uid.split("@")[1]).split(":")[0] }}, Parent, Name, @{n="SDError"; e={SDErrorsOnHost -GetVMHost $_}} | Where-Object {$_.SDError -eq $true}
    if ($null -eq $vCenterAlarmHost) {
        $ActionAlarmEnabledReport = "All hosts are OK"
        $FinalReport = $mycheder1 + $ActionAlarmEnabledReport  + " `n "
    } else {
        $prop1 = @{Expression='vCenter'; Ascending=$true }
        $prop2 = @{Expression='Parent'; Ascending=$true }
        $ActionAlarmEnabledReport  = $vCenterAlarmHost | Sort-Object $prop1,$prop2 |  convertto-html -fragment
        $FinalReport = $mycheder1 + $ActionAlarmEnabledReport  + " `n "
    }
    $FinalReport | Out-File "$($tempPath)09.SDError.txt" -Force
    Add-Content -path "$($tempPath)SDReport.log" -value "INFORMATION, $(Get-Date) Finished SDReport"
}
#endregion

#region RAM failures
$RAMReport = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)RAMReport.log" -value "INFORMATION, $(Get-Date) Starting RAMReport"
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Hosts That had RAM Disk Errors in the last 48 Hours</b></p> `n"
    $vCenterAlarmHost = Get-VMHost | Select-Object @{n="vCenter"; e={($_.uid.split("@")[1]).split(":")[0] }}, Parent, Name, @{n="RAMDiskError"; e={RAMDiskError -GetVMHost $_}} | Where-Object {$_.RAMDiskError -eq $true}
    if ($null -eq $vCenterAlarmHost) {
        $ActionAlarmEnabledReport = "All hosts are OK"
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $mycheder1 + $query_time + $ActionAlarmEnabledReport  + " `n "
    } else {
        $prop1 = @{Expression='vCenter'; Ascending=$true }
        $prop2 = @{Expression='Parent'; Ascending=$true }
        $ActionAlarmEnabledReport  = $vCenterAlarmHost | Sort-Object $prop1,$prop2 |  convertto-html -fragment
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $mycheder1 + $query_time + $ActionAlarmEnabledReport  + " `n "
    }
    $FinalReport | Out-File "$($tempPath)10.RAMDiskError.txt" -Force
    Add-Content -path "$($tempPath)RAMReport.log" -value "INFORMATION, $(Get-Date) Finished RAMReport"
}
#endregion

#region Autostart activated on hosts or VMS
$VMStartPolicyCheck = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)VMStartPolicyCheck.log" -value "INFORMATION, $(Get-Date) Starting VMStartPolicyCheck"
    $filterTable = @()
    $VMhostTable = get-vmhost | Where-Object {($_.IsStandAlone -eq $true) -and ($_.ConnectionState -ne "Maintenance")} | Select-Object `
    @{n="vCenter"; e={($_.uid.split("@")[1]).split(":")[0] }},
    @{n="Hostname"; e={$_.Name}},
    @{n="VMHostStartPolicy"; e={$script:startpolicybul = IsEnabled -getvmhost $_; $startpolicybul}},
    @{n="VMsStartPolicy"; e={if ($startpolicybul) {$script:answer = IsAllVMsEnabled -getvmhost $_}else{$script:answer = $startpolicybul}; $answer}}
    $filterTable = $VMhostTable | Where-Object {($_.VMHostStartPolicy -eq $False) -or ($_.VMsStartPolicy -eq $False)}
    $prop1 = @{Expression='vCenter'; Ascending=$true }
    $prop2 = @{Expression='Hostname'; Ascending=$true }   
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Virtual Machine Auto Startup</b></p> `n"
    $filterVMstartPolicyReport  = $filterTable | Sort-Object $prop1,$prop2 |  convertto-html -fragment
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $FinalReport = $mycheder1 + $query_time + $filterVMstartPolicyReport   + " `n "
    $FinalReport | Out-File "$($tempPath)08.VMStartPolicyCheck.txt" -Force
    Add-Content -path "$($tempPath)VMStartPolicyCheck.log" -value "INFORMATION, $(Get-Date) Finished VMStartPolicyCheck"
}
#endregion

#region Virtual Storage Area Network active
<#
$VSANStatus = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)VSANStatus.log" -value "INFORMATION, $(Get-Date) Starting VSANStatus"
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>ESXi hosts with vSAN service enabled</b></p> `n"
	$vmhostsView = get-view -ViewType HostSystem -Property Name, Config.Product.version | Select-Object Name, @{ n = "ESXi Version"; e = { $_.Config.Product.version } }
	#Filter vCF hosts as they're using vSAN enabled
	$vmhostsView = $vmhostsView | where-Object -property Name -notlike "ilvcfesx??.teva.corp" | where-Object -property Name -notlike "*ilvcf*"
	$VSANEnabledHosts = Get-VMHost ($vmhostsView | ForEach-Object{$_.Name}) | Select-Object @{n="vCenter"; e={($_.uid.split("@")[1]).split(":")[0] }}, Parent,Name, @{n="vSAN Status"; e={CheckVSANService($_)}} | Where-Object {$_."vSAN Status" -eq $true}
    if ($null -eq $VSANEnabledHosts) {
        $VSANEnabledHostsReport = "All hosts are OK"
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $mycheder1 + $query_time + $VSANEnabledHostsReport + " `n "
    } else {
        $prop1 = @{Expression='vCenter'; Ascending=$true }
        $prop2 = @{Expression='Parent'; Ascending=$true }
        $VSANEnabledHostsReport  = $VSANEnabledHosts | Sort-Object $prop1,$prop2 |  convertto-html -fragment
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $mycheder1 + $query_time + $VSANEnabledHostsReport + " `n " 
    }
    $FinalReport | Out-File "$($tempPath)11.VSAN-Status.txt" -Force
    Add-Content -path "$($tempPath)VSANStatus.log" -value "INFORMATION, $(Get-Date) Finished VSANStatus"
}
#>
#endregion

#region I/O Virtualization from Cisco
$CiscoIOVStatus = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)CiscoIOVStatus.log" -value "INFORMATION, $(Get-Date) Starting CiscoIOVStatus"
    $vmhostsView = get-view -ViewType HostSystem -Property Name,Summary.Hardware, Config.Product.version | Select-Object Name,@{n="Vendor"; e={$_.Summary.Hardware.Vendor}}, @{n="Model"; e={$_.Summary.Hardware.Model}} | Where-Object {$_.Vendor -like "Cisco*"}
    $vmhosts = Get-VMHost ($vmhostsView | ForEach-Object{$_.Name})
    $IOVEnabledHosts = $vmhosts| Select-Object @{n="vCenter"; e={($_.uid.split("@")[1]).split(":")[0] }}, Parent, Name,
    @{n="Interrupt Routing Configuration"; e={(GetIRStatus ($_)).configured}},
    @{n="Interrupt Routing Runtime"; e={(GetIRStatus ($_)).runtime}} | Where-Object {($_."Interrupt Routing Configuration" -eq $false) -or ($_."Interrupt Routing Runtime" -eq $false)}
    $prop1 = @{Expression='vCenter'; Ascending=$true }
    $prop2 = @{Expression='Parent'; Ascending=$true }
    $prop3 = @{Expression='Name'; Ascending=$true }
    $IOVEnabledHostsReport  = $IOVEnabledHosts | Sort-Object $prop1,$prop2,$prop3 |  convertto-html -fragment
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Cisco hosts with Interrupt Routing enabled</b></p> `n"
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $FinalReport = $mycheder1 + $query_time + $IOVEnabledHostsReport  + " `n "
    $FinalReport | Out-File "$($tempPath)11.Cisco-IOV.txt" -Force
    Add-Content -path "$($tempPath)CiscoIOVStatus.log" -value "INFORMATION, $(Get-Date) Finished CiscoIOVStatus"
}
#endregion

#region Find Orphaned VMs
$OrphanedVMs= {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)OrphanedVMs.log" -value "INFORMATION, $(Get-Date) Starting OrphanedVMs"
    $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Orphaned VMs</b></p> `n"
    $OrphanedVMslist=@()
    foreach ($vm in (get-vm)) {
        if ($vm.ExtensionData.Runtime.ConnectionState -eq "orphaned") {
              $row="" |Select-Object vCenter,VMName
              $row.VMName= $vm.name
              $row.vCenter= $vm.VMHost.uid.split("@")[1].split(":")[0]
              $orphanedVMslist += $row
            }
        }
    if ("" -eq $OrphanedVMslist) {
        $OrphanedVMsReport = "All VMs are OK"
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $mycheder1 + $query_time + $OrphanedVMsReport  + " `n "
    } else {
        $OrphanedVMsReport = $OrphanedVMslist | Sort-Object -property vCenter |  convertto-html -fragment
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $mycheder1 + $query_time + $OrphanedVMsReport  + " `n "
    }
    $FinalReport | Out-File "$($tempPath)13.OrphanedVMs.txt" -Force
    Add-Content -path "$($tempPath)OrphanedVMs.log" -value "INFORMATION, $(Get-Date) Finished OrphanedVMs"
}
#endregion

<# #TODO: delete this section
#region vCenters availability List
$vCentersList = {
	Set-Content -path "$($tempPath)vCenters_Availability.log" -value "INFORMATION, $(Get-Date) Starting Checking Availability"
	$mycheder1 = "<p style=`"background-color:#4E8DC2;`"><b>Queried vCenters</b></p> `n"
	
	$ZeroUptimeHostsReport = $ZeroUptimeHosts | Sort-Object $prop1, $prop2 | convertto-html -fragment
	$FinalReport = $mycheder1 + $ZeroUptimeHostsReport + " `n "
	$FinalReport | Out-File "$($tempPath)12.HostsUptime.txt" -Force
	Add-Content -path "$($tempPath)ZeroUptime.log" -value "INFORMATION, $(Get-Date) Finished ZeroUptime"
}
#endregion
#>
#region support functions
$functions = {
    function GetIRStatus ($vmhost){
        $esxcli = Get-EsxCli -VMHost $vmhost
	    if($null -ne $esxcli){
            $return = @{} 
            $return.configured =  $esxcli.system.settings.kernel.list($null, "iovDisableIR") | ForEach-Object{$_.Configured}
            $return.runtime =  $esxcli.system.settings.kernel.list($null, "iovDisableIR") | ForEach-Object{$_.Runtime}
            return $return
        }
    }

    function CheckVSANService ($VMHost_name){
        $esxcli = Get-EsxCli -VMHost $VMHost_name
        $service = $esxcli.system.process.list() | ForEach-Object{$_.name}
        If ($service -contains "vsantraced"){
            Return $True
        }else{
            Return $false
        }
    }

    #is all vms on the host are configured to start automatically with the host
    function IsAllVMsEnabled ($getvmhost) {
        $vms_disabled = $getvmhost | Get-VMStartPolicy | Where-Object {$_.StartAction -eq "None"} | Select-Object VM | ForEach-Object{$_.VM} | ForEach-Object{$_.Name}
        if ($null -ne $vms_disabled) {
            foreach ($vm_disabled in $vms_disabled){
                if(((get-vm $vm_disabled).PowerState) -eq "PoweredOn") {
                    return $False
                }
            }
        }else{
            return $True
        }
    }

    #is the host enabled for startVM with host or not
    function IsEnabled ($getvmhost){ 
        $start_policy = ($getvmhost | Get-VMHostStartPolicy).Enabled
        return $start_policy
    }

    Function RAMDiskError ($GetVMHost){
        $Last48Hours = (Get-Date).AddDays(-2)
        $events = $GetVMHost | Get-VIEvent -MaxSamples 1000 -Start $Last48Hours | Where-Object {$_.FullFormattedMessage -like "*ramdisk 'root' is full*"}
        if ($events){
            return $true
        }
        else{
            return $false
        }
    }

    function Getmytime($vmhostname){
        $allowedDifferenceSeconds = 10
        $hostView = Get-VMHost $vmhostname | Get-View
        $dts = Get-View $hostView.ConfigManager.DateTimeSystem
        #get host time
        $t = $dts.QueryDateTime()
        #calculate time difference in seconds
        $s = ( $t - [DateTime]::UtcNow).TotalSeconds   
        #check if time difference is too much
        if([math]::abs($s) -gt $allowedDifferenceSeconds){
            return $False
        }else {
            return $True
        }
    }

    function GetmyNTP($vmhostname){
        $ntpservice = Get-VmHostService -VMHost $vmhostname | Where-Object {($_.key -eq "ntpd") -and ($_.Running -eq $true)}
        $ntp = Get-VMHostNtpServer -VMHost $vmhostname
        switch ($ntp){ 
            "gntp.il.teva.corp" {return $True} 
            "10.128.8.50" {return $True}
            "10.129.100.18" {return $True} 		
            default {return $False}
        }
    }

    function GetNTP(){
        $mycheder1="<p style=`"background-color:#4E8DC2;`"><b>Time Settings and NTP Service</b></p> `n"
        $vmhosts = Get-VMHost | Where-Object{($_.ConnectionState -ne "NotResponding") -and ($_.ConnectionState -ne "Disconnected") }
        $allhosts = $vmhosts | Select-Object Parent, Name, @{n="TimeSettings"; e={Getmytime($_.Name)}}, @{n="NTPSettings"; e={GetmyNTP($_.Name)}}
        $OnlyFalse = $allhosts | Where-Object {($_.TimeSettings -eq $false) -or ($_.NTPSettings -eq $false) } | Sort-Object Parent
        $prop1 = @{Expression='Parent'; Ascending=$true }
        $prop2 = @{Expression='Name'; Ascending=$true }
        $NTPReport  = $OnlyFalse | Sort-Object $prop1,$prop2 |  convertto-html -fragment
        $FinalReport = $mycheder1 + $NTPReport  + " `n "
        $FinalReport | Out-File "$tempPath\05.GetNTP.txt" -Force
    }

    Function SDErrorsOnHost ($GetVMHost){
        $Last48Hours = (Get-Date).AddDays(-2)
        $events = $GetVMHost | Get-VIEvent -MaxSamples 500 -Start $Last48Hours | Where-Object {$_.FullFormattedMessage -like "*bootbank*"}
        if($events){
            return $true
        }else{
            return $false
        }
    }

    function CyberArkPAM ($AccountID) {
        $PAMAuthenticationURI = "/v1/auth/approle/login"
        $PAMAccountPAsswordURI = "/v1/vsphered/data/$AccountID"
        $PAMServer = "ilpshapp01.teva.corp:8200"
        
        $BaseURL = "http://" + $PAMServer
        $AuthenticationURL = $BaseURL + $PAMAuthenticationURI
        $AccountPasswordURL = $BaseURL + $PAMAccountPAsswordURI
        $TokenHeaders = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
        $TokenHeaders.Add("Content-Type", "application/json")
        $PAMAccount = New-Object -TypeName PSObject
        $TokenBody = "{
            `n  `"role_id`": `"8faa6321-f1f2-d460-e54d-7fc0acb57a72`",
            `n  `"secret_id`": `"ea2f6d3a-0181-a1f9-6d46-544ea4bcb6bf`"
            `n}"
        
        $token = $null
        
            Try
            {
                $TokenResponse = Invoke-RestMethod $AuthenticationURL -Method 'POST' -Headers $TokenHeaders -Body $TokenBody
                $TokenResponse | ConvertTo-Json
                $token = $TokenResponse.auth.client_token.Replace('"',"")
            }
            Catch {
                $ErrorMessage = $_.Exception.Message
                Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . CyberArkPAM: Failed to get token: $ErrorMessage"
                return $null
            }
        
        $PasswordHeaders = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
        $PasswordHeaders.Add("X-Vault-Token", "$token")
        
        if ($token)
        {
            try
            {
                $PasswordResponse = Invoke-RestMethod $AccountPasswordURL -Method 'GET' -Headers $PasswordHeaders
                $PasswordResponse | ConvertTo-Json
                $AccountPassword = $PasswordResponse.data.data.password.Replace('"',"")
                $PAMAccount | Add-Member -Force -MemberType NoteProperty -Name Password -Value $AccountPassword
                return $PAMAccount
            }
            catch
            {
                $ErrorMessage = $_.Exception.Message
                Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . CyberArkPAM: Failed to get password: $ErrorMessage"
                return $null
            }
        }
    }
    
    function Get-RestAPICall {
        param(
            [Parameter(Position=0, Mandatory = $true, ValueFromPipeline = $true)] `
                [string]$url,
            [Parameter(Position=1, Mandatory = $true, ValueFromPipeline = $true)] `
                [System.Collections.Generic.Dictionary[[String],[String]]]$headers
        )
        try {
            if ($headers) {
                $request = Invoke-RestMethod -Method GET -Headers $headers -Uri $url
            } else {
                $request = Invoke-RestMethod -Uri $url
            }
        } catch [System.Net.WebException] {
            $exceptionError = $_.Exception

            switch ($exceptionError.Response.StatusCode.value__) {
                "200"   {
                    Write-Host "=> Get-RestAPICall -> OK - $url <=" `
                }
                "400"   {
                    Write-Host "=> Get-RestAPICall -> Bad Request - $url <=" `
                    $request = $null
                }
                "404"   {
                    Write-Host "=> Get-RestAPICall -> Not Found - $url <=" `
                    $request = $null
                }
                "405"   {
                    Write-Host "=> Get-RestAPICall -> Invalid Method - $url <=" `
                    Write-Host "=> StatusCode:" $exceptionError.Response.StatusCode.value__ `
                    Write-Host "=> StatusDescription:" $exceptionError.Response.StatusDescription `
                    Write-Host "=> Type:" $exceptionError.GetType() -ForegroundColor Yellow
                    Exit
                }
                "500"   {
                    Write-Host "=> Get-RestAPICall -> Internal Server Error - $url <=" `
                    Write-Host "=> StatusCode:" $exceptionError.Response.StatusCode.value__ `
                    Write-Host "=> StatusDescription:" $exceptionError.Response.StatusDescription `
                    Write-Host "=> Type:" $exceptionError.GetType() -ForegroundColor Yellow
                    Exit
                }
                "503"   {
                    Write-Host "=> Get-RestAPICall -> Service Unavailable - $url <=" `
                    Write-Host "=> StatusCode:" $exceptionError.Response.StatusCode.value__ `
                    Write-Host "=> StatusDescription:" $exceptionError.Response.StatusDescription `
                    Write-Host "=> Type:" $exceptionError.GetType() -ForegroundColor Yellow
                    Exit
                }
                default  {
                    Write-Host "=> Get-RestAPICall -> Unspecified Error - $url <=" `
                    Write-Host "=> StatusCode:" $exceptionError.Response.StatusCode.value__ `
                    Write-Host "=> StatusDescription:" $exceptionError.Response.StatusDescription `
                    Write-Host "=> Type:" $exceptionError.GetType() -ForegroundColor Yellow
                    Exit
                }
            }
        }

        return $request
    }

    function Post-RestAPICall {
        param(
            [Parameter(Position=0, Mandatory = $true, ValueFromPipeline = $true)] `
                [string]$url,
            [Parameter(Position=2, Mandatory = $false, ValueFromPipeline = $true)] `
                [string]$payload,
            [Parameter(Position=3, Mandatory = $true, ValueFromPipeline = $true)] `
                [System.Collections.Generic.Dictionary[[String],[String]]]$headers
        )

        try {
            if ($headers) {
                $request = Invoke-RestMethod -Method POST -Headers $headers -Body $payload -Uri $url
            } else {
                $request = Invoke-RestMethod -Body $payload -Uri $url
            }
        } catch [System.Net.WebException] {
            $exceptionError = $_.Exception

            switch ($exceptionError.Response.StatusCode.value__) {
                "200"   {
                    Write-Host "=> Post-RestAPICall -> OK - $url <=" -ForegroundColor Green
                }
                "400"   {
                    Write-Host "=> Post-RestAPICall -> Bad Request - $url <=" -ForegroundColor Red
                    $request = $null
                }
                "500"   {
                    Write-Host "=> Post-RestAPICall -> Unspecified Error - $url <=" `
                    Write-Host "=> StatusCode:" $exceptionError.Response.StatusCode.value__ `
                    Write-Host "=> StatusDescription:" $exceptionError.Response.StatusDescription `
                    Write-Host "=> Type:" $exceptionError.GetType() -ForegroundColor Yellow
                    Exit
                }
                default  {
                    Write-Host "=> Post-RestAPICall -> Unspecified Error - $url <=" `
                    Write-Host "=> StatusCode:" $exceptionError.Response.StatusCode.value__ `
                    Write-Host "=> StatusDescription:" $exceptionError.Response.StatusDescription `
                    Write-Host "=> Type:" $exceptionError.GetType() -ForegroundColor Yellow
                    Exit
                }
            }
        }
        return $request
    }
}
#endregion

#region ZERTO Deleted VPGs Status
$ZertoVPGsDeleteEvents = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)ZertoVPGsDeleteEvents.log" -value "INFORMATION, $(Get-Date) Starting ZertoVPGsDeleteEvents Check"
    $ZertoPort = "9669"
    $ZertoUser = $ZertoCreds.UserName
    $ZertoPassword = $ZertoCreds.GetNetworkCredential().Password
    [System.Collections.ArrayList]$ZVMs = Get-Content -Path $ZertoGlobaServersList
    $DeletedVPGs = @()

    add-type @"
        using System.Net;
        using System.Security.Cryptography.X509Certificates;
        public class TrustAllCertsPolicy : ICertificatePolicy {
            public bool CheckValidationResult(
            ServicePoint srvPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
            }
        }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy -WarningAction SilentlyContinue
            
    foreach ($ZVM in $ZVMs) {
        ################################################
        # Building Zerto API string and invoking API
        ################################################
        $BaseURL = "https://" + $ZVM + ":"+$ZertoPort+"/v1/"
        # Authenticating with Zerto APIs
        $xZertoSessionURL = $BaseURL + "session/add"
        $AuthInfo = ("{0}:{1}" -f $ZertoUser,$ZertoPassword)
        $AuthInfo = [System.Text.Encoding]::UTF8.GetBytes($AuthInfo)
        $AuthInfo = [System.Convert]::ToBase64String($AuthInfo)
        $Headers = @{Authorization=("Basic {0}" -f $AuthInfo)}
        $SessionBody = '{"AuthenticationMethod": "1"}'
        $TypeJSON = "application/JSON"
        #$TypeXML = "application/XML"
        Try
        {
            $xZertoSessionResponse = Invoke-WebRequest -Uri $xZertoSessionURL -Headers $Headers -Method POST -Body $SessionBody -ContentType $TypeJSON
            $xZertoSession = $xZertoSessionResponse.headers.get_item("x-zerto-session")
            $ZertoSessionHeader = @{"x-zerto-session"=$xZertoSession}
        }
        Catch {
            Write-Host $_.Exception.ToString()
            $error[0] | Format-List -Force
        }
        #Extracting x-zerto-session from the response, and adding it to the actual API
        $StartDate = (get-date).AddDays(-3).ToString("yyyy-MM-dd")
        $EndDate = (get-date).ToString("yyyy-MM-dd")
        $VPGsURI = $BaseURL+"events?startDate=$StartDate&endDate=$EndDate"
        if ($ZertoSessionHeader.Values)
        {
            try
            {
                $Events = Invoke-RestMethod -Uri $VPGsURI -TimeoutSec 100 -Headers $ZertosessionHeader -ContentType $TypeJSON
                $Events = $Events | Where-Object {$_.description -like "*Protection group removal*"} | Select-Object Description,UserName,OccurredOn,@{ Label="VPG_Name";Expression={$_.Vpgs.VpgName}}
                foreach ($Event in $Events)
                {                 
                        $array = New-Object -TypeName PSObject
                        $array | Add-Member -Force -MemberType NoteProperty -Name "ZVM Server" -Value $ZVM
                        $array | Add-Member -Force -MemberType NoteProperty -Name "UserName" -Value $Event.UserName
                        $array | Add-Member -Force -MemberType NoteProperty -Name "OccurredOn" -Value $Event.OccurredOn
                        $array | Add-Member -Force -MemberType NoteProperty -Name "VPG_Name" -Value $Event.VPG_Name
                        $DeletedVPGs += $array                    
                }
            }
            catch 
            {
                Write-Host $_.Exception.ToString()
                $error[0] | Format-List -Force
            }
        }

    }

    $header="<p style=`"background-color:#4E8DC2;`"><b>Zerto deleted VPGs events for the last 3 days</b></p> `n"
    if ($DeletedVPGs.Count -eq 0) {
        $VPGsFinalReport = "There are no VPGs were deleted during the last 3 days"
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $header + $query_time + $VPGsFinalReport + " `n "
    } else {
        $VPGsFinalReport = $DeletedVPGs | ConvertTo-Html -fragment
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $FinalReport = $header + $query_time + $VPGsFinalReport + " `n "
    }
    $FinalReport | Out-File "$tempPath\16.ZertoVPGsDeleteEvents.txt" -Force
    Set-Content -path "$($tempPath)ZertoVPGsDeleteEvents.log" -value "INFORMATION, $(Get-Date) Finish ZertoVPGsDeleteEvents Check"
}
#endregion

#region PSCs Health Status
$PSCsHealthStatus = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)PSCsHealthStatus.log" -value "INFORMATION, $(Get-Date) Starting PSCsHealthStatus"
    [System.Collections.ArrayList]$PSCs_NEW_LIST = Get-Content -Path $PSCs_NEW
    $PSCHealthStatusReport = @()
    foreach ($PSC in $PSCs_NEW_LIST){
        $array = New-Object -TypeName PSObject
        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_Name" -Value $PSC
        
            $PSC_TOKEN_URI = "/rest/com/vmware/cis/session"
            $PSC_SYSTEM_STATUS_URI = "/rest/appliance/health/system"
            $PSC_APPLIANCE_SERVICES_URI = "/rest/appliance/health/applmgmt"
            $PSC_DATABASE_STORAGE_URI = "/rest/appliance/health/database-storage"
            $PSC_LOAD_URI = "/rest/appliance/health/load"
            $PSC_MEMORY_URI = "/rest/appliance/health/mem"
            $PSC_STORAGE_URI = "/rest/appliance/health/storage"
            $PSC_SWAP_URI = "/rest/appliance/health/swap"
            $PSC_LAST_SYSTEM_CHECK_URI = "/rest/appliance/health/system/lastcheck"
            $PSC_BACKUP_JOBS_URI = "/rest/appliance/recovery/backup/job"
            $PSC_LAST_BACKUP_JOB_URI = "/rest/appliance/recovery/backup/job/"

            ################################################
            # Building vCenter API string and invoking API
            ################################################
            $cred = $null
            $i = 5       
            Do {
                Write-Host $i
                Start-Sleep 10
                $cred = CyberArkPAM -AccountID $vCentersDetails.($PSC)
                $i--
            } While (($null -eq $cred) -and ($i -gt 0))
            if ($cred) {
                $vCenterSSOUsername = "administrator@vsphere.local"
                $BaseURL = "https://" + $PSC
                $TokenURL = $BaseURL + $PSC_TOKEN_URI
                $PSC_SYSTEM_STATUS_URL = $BaseURL + $PSC_SYSTEM_STATUS_URI
                $PSC_APPLIANCE_SERVICES_URL = $BaseURL + $PSC_APPLIANCE_SERVICES_URI
                $PSC_DATABASE_STORAGE_URL = $BaseURL + $PSC_DATABASE_STORAGE_URI
                $PSC_LOAD_URL = $BaseURL + $PSC_LOAD_URI
                $PSC_MEMORY_URL = $BaseURL + $PSC_MEMORY_URI
                $PSC_STORAGE_URL = $BaseURL + $PSC_STORAGE_URI
                $PSC_SWAP_URL = $BaseURL + $PSC_SWAP_URI
                $PSC_LAST_SYSTEM_CHECK_URL = $BaseURL + $PSC_LAST_SYSTEM_CHECK_URI
                $PSC_BACKUP_JOBS_URL = $BaseURL + $PSC_BACKUP_JOBS_URI
                $PSC_LAST_BACKUP_JOB_URL = $BaseURL + $PSC_LAST_BACKUP_JOB_URI
                $headers = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
                $headers.Add("Content-Type" , "application/json")
                $headers.Add("Content-Accept" , "application/json")
                $AuthInfo = ("{0}:{1}" -f $vCenterSSOUsername, $cred.Password)
                $AuthInfo = [System.Text.Encoding]::UTF8.GetBytes($AuthInfo)
                $AuthInfo = [System.Convert]::ToBase64String($AuthInfo)
                $headers.Add("Authorization", "Basic {0}" -f $AuthInfo)

                Try
                {
                    $request = Post-RestAPICall -url $TokenURL -headers $headers
                    $token = $request.value.ToString()
                    $headers.Add("vmware-api-session-id",$token)                    
                }
                Catch {
                    Write-Host $_.Exception.ToString()
                    $error[0] | Format-List -Force
                    Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get token."
                    $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_GET_TOKEN" -Value "FAILED TO OBTAIN TOKEN." $_.Exception.ToString()
                }
                if ($token)
                {
                    try
                    {
                        $PSC_SYSTEM_HEALTH_STATUS = Get-RestAPICall -url $PSC_SYSTEM_STATUS_URL -Headers $headers
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_SYSTEM_HEALTH_STATUS" -Value $PSC_SYSTEM_HEALTH_STATUS.value
                    }
                    catch 
                    {
                        Write-Host $_.Exception.ToString()
                        $error[0] | Format-List -Force
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get PSC_SYSTEM_HEALTH_STATUS."
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_SYSTEM_HEALTH_STATUS" -Value $_.Exception.ToString()
                    }
                    try
                    {
                        $PSC_APPLIANCE_SERVICES_STATUS = Get-RestAPICall -url $PSC_APPLIANCE_SERVICES_URL -Headers $headers
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_APPLIANCE_SERVICES_STATUS" -Value $PSC_APPLIANCE_SERVICES_STATUS.value
                    }
                    catch 
                    {
                        Write-Host $_.Exception.ToString()
                        $error[0] | Format-List -Force
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get PSC_APPLIANCE_SERVICES_STATUS."
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_APPLIANCE_SERVICES_STATUS" -Value $_.Exception.ToString()
                    }
                    try
                    {
                        $PSC_DATABASE_STORAGE_STATUS = Get-RestAPICall -url $PSC_DATABASE_STORAGE_URL -Headers $headers
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_DATABASE_STORAGE_STATUS" -Value $PSC_DATABASE_STORAGE_STATUS.value
                    }
                    catch 
                    {
                        Write-Host $_.Exception.ToString()
                        $error[0] | Format-List -Force
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get PSC_DATABASE_STORAGE_STATUS."
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_DATABASE_STORAGE_STATUS" -Value $_.Exception.ToString()
                    }
                    try
                    {
                        $PSC_LOAD_STATUS = Get-RestAPICall -url $PSC_LOAD_URL -Headers $headers
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_LOAD_STATUS" -Value $PSC_LOAD_STATUS.value
                    }
                    catch 
                    {
                        Write-Host $_.Exception.ToString()
                        $error[0] | Format-List -Force
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get PSC_LOAD_STATUS."
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_LOAD_STATUS" -Value $_.Exception.ToString()
                    }
                    try
                    {
                        $PSC_MEMORY_STATUS = Get-RestAPICall -url $PSC_MEMORY_URL -Headers $headers
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_MEMORY_STATUS" -Value $PSC_MEMORY_STATUS.value
                    }
                    catch 
                    {
                        Write-Host $_.Exception.ToString()
                        $error[0] | Format-List -Force
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get PSC_MEMORY_STATUS."
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_MEMORY_STATUS" -Value $_.Exception.ToString()
                    }
                    try
                    {
                        $PSC_STORAGE_STATUS = Get-RestAPICall -url $PSC_STORAGE_URL -Headers $headers
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_STORAGE_STATUS" -Value $PSC_STORAGE_STATUS.value
                    }
                    catch 
                    {
                        Write-Host $_.Exception.ToString()
                        $error[0] | Format-List -Force
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get PSC_STORAGE_STATUS."
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_STORAGE_STATUS" -Value $_.Exception.ToString()
                    }
                    try
                    {
                        $PSC_SWAP_STATUS = Get-RestAPICall -url $PSC_SWAP_URL -Headers $headers
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_SWAP_STATUS" -Value $PSC_SWAP_STATUS.value
                    }
                    catch 
                    {
                        Write-Host $_.Exception.ToString()
                        $error[0] | Format-List -Force
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get PSC_SWAP_STATUS."
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_SWAP_STATUS" -Value $_.Exception.ToString()
                    }
                    try
                    {
                        $PSC_LAST_SYSTEM_CHECK_STATUS = Get-RestAPICall -url $PSC_LAST_SYSTEM_CHECK_URL -Headers $headers
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_LAST_SYSTEM_CHECK_STATUS" -Value $PSC_LAST_SYSTEM_CHECK_STATUS.value
                    }
                    catch 
                    {
                        Write-Host $_.Exception.ToString()
                        $error[0] | Format-List -Force
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get PSC_LAST_SYSTEM_CHECK_STATUS."
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_LAST_SYSTEM_CHECK_STATUS" -Value $_.Exception.ToString()
                    }
                    try
                    {
                        $backupsRow = Get-RestAPICall -url $PSC_BACKUP_JOBS_URL -Headers $headers
                        $backups = $backupsRow.value | Where-Object {$_ -like ((get-date).AddDays(-2).ToString("yyyyMMdd*"))}
                    }
                    catch 
                    {
                        Write-Host $_.Exception.ToString()
                        $error[0] | Format-List -Force
                        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get PSC_BACKUP_JOBS_URL."
                        $array | Add-Member -Force -MemberType NoteProperty -Name "PSC_BACKUP_JOBS_URL" -Value $_.Exception.ToString()
                    }
                    if ($null -ne $backups) {
                        try {
                            $backupStatus = Get-RestAPICall -url ($PSC_LAST_BACKUP_JOB_URL + $backups) -Headers $headers
                            $array | Add-Member -Force -MemberType NoteProperty -Name "LAST_BACKUP" -Value $backupStatus.value.state
                        }
                        catch {
                             Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: " $PSC " Failed to get PSC_BACKUP_JOBS_URL."
                        }
                    } else {
                        $array | Add-Member -Force -MemberType NoteProperty -Name "LAST_BACKUP" -Value ("the last backup was at " + ((ConvertFrom-Json $backupsRow).value | Select-Object -First 1))
                    }
                    $PSCHealthStatusReport += $array
                } else {
                    continue
                }
            } else {
                Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . PSCsStatus: PSC $PSC failed to get credentials from PAM."
            }        
    }
        $PSCHealthStatusFinalReport = $PSCHealthStatusReport
        $header="<p style=`"background-color:#4E8DC2;`"><b>PSCs Health Status</b></p> `n"
        $PSCHealthStatusReportHTML = $PSCHealthStatusFinalReport | ConvertTo-Html -fragment
        $PSCHealthStatusReportHTML = $PSCHealthStatusReportHTML -replace "<td>SUCCEEDED</td>", '<td bgcolor="Green">SUCCEEDED</td>'
        $PSCHealthStatusReportHTML = $PSCHealthStatusReportHTML -replace "<td>green</td>", '<td bgcolor="Green">HEALTHY</td>'
        $PSCHealthStatusReportHTML = $PSCHealthStatusReportHTML -replace "<td>orange</td>", '<td bgcolor="Orange">WARNING</td>'
        $PSCHealthStatusReportHTML = $PSCHealthStatusReportHTML -replace "<td>FAILED</td>", '<td bgcolor="red">FAILED</td>'
        $PSCHealthStatusReportHTML = $PSCHealthStatusReportHTML -replace "<td>red</td>", '<td bgcolor="red">FAILED</td>'
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $VCSABackupsStatusHTML = $header + $query_time + $PSCHealthStatusReportHTML + " `n "
        $VCSABackupsStatusHTML | Out-File "$($tempPath)14.PSCsHealthStatus.txt" -Force 
        Add-Content -path "$($tempPath)PSCsHealthStatus.log" -value "INFORMATION, $(Get-Date) Finished PSCsHealthStatus"
}
#endregion

#region Datastores with low free space
$DatastoresFreeSpaceStatus = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)DatastoresFreeSpaceStatus.log" -value "INFORMATION, $(Get-Date) Starting DatastoresFreeSpaceStatus"
    [System.Collections.ArrayList]$VROPS_LIST = Get-Content -Path $vROPsList
    $CriticalDatastores = @()
    $WarningDatastores = @()
    foreach ($vROPS in $VROPS_LIST) {
        $cred = $null
        $i = 5       
        Do {
            Write-Host $i
            Start-Sleep 10
            $cred = CyberArkPAM -AccountID $vCentersDetails.($vROPS)
            $i--
        } While (($null -eq $cred) -and ($i -gt 0))
        try {
            $result = Connect-OMServer -Server $vROPS -User $cred.Username -Password $cred.Password -AuthSource 'TEVA'
        }
        catch {
            $ErrorMessage = $_.Exception.Message  
            Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . DatastoresFreeSpaceStatus $vROPS : failed to connect" $ErrorMessage
        }            
        ################################################
        # Building vCenter API string and invoking API
        ################################################

        if ($result) {
            $alldatastores = $null
            $alldatastores = Get-OMResource -ResourceKind datastore
            $datastores = $alldatastores
            #$datastores = $alldatastores | Select-Object -Unique # remove duplicaed datastores seen from more than once vCenter
            if ($datastores) {
                $omMetrics = 'capacity|usedSpacePct'
                $startDate = (get-date).AddDays(-1).ToString("MM/dd/yyyy")
                $endDate = (get-date).AddDays(-1).ToString("MM/dd/yyyy")
                $FreeSpaceIssueDatastores = $null
                $FreeSpaceIssueDatastores = Get-OMStat -Resource $datastores -Key $omMetrics -IntervalType 'day' -IntervalCount '1' -RollupType 'Avg' -From $startDate -To $endDate | Where-Object {($_.Value -gt '70')}
                foreach ($ds in $FreeSpaceIssueDatastores) {
                    $array = New-Object -TypeName PSObject
                    if ([math]::Floor($ds.Value) -gt '80') {
                        $array | Add-Member -Force -MemberType NoteProperty -Name "vCenter_Name" -Value (Get-OMResource -Id ((Get-OMResource -name $ds.Resource).AdapterInstanceId)).name
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Datastore_Name" -Value $ds.Resource
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Datastore_Used_Size_%" -Value ([math]::Floor($ds.Value))
                        $CriticalDatastores += $array
                    } 
                    else {
                        $array | Add-Member -Force -MemberType NoteProperty -Name "vCenter_Name" -Value (Get-OMResource -Id ((Get-OMResource -name $ds.Resource).AdapterInstanceId)).name
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Datastore_Name" -Value $ds.Resource
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Datastore_Used_Size_%" -Value ([math]::Floor($ds.Value))
                        $WarningDatastores += $array
                    }
                }
            } 
            else {
                Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . serviceStatus: DatastoresFreeSpaceStatus $vROPS : failed to get datastores"
            }
        }
        else {
            Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . DatastoresFreeSpaceStatus: failed to get credentials from PAM."
        }
        Disconnect-OMServer -Server $vROPS -Force:$true -Confirm:$false
    }
    $header="<p style=`"background-color:#4E8DC2;`"><b>CRITICAL Datastores free size for the last 24 hours</b></p> `n"
    $Critical = $CriticalDatastores | Sort-Object "Datastore_Used_Size_%" -Descending
    $reportHTML = $Critical | ConvertTo-Html -fragment
    $DatastoresFreeSpaceStatus = $header + $reportHTML + " `n "
    $DatastoresFreeSpaceStatus | Out-File "$($tempPath)17.CRITICALDatastoresFreeSpaceStatusHTML.txt" -Force 

    $header="<p style=`"background-color:#4E8DC2;`"><b>WARNING Datastores free size in % for the last 24 hours</b></p> `n"
    $Warning = $WarningDatastores | Sort-Object "Datastore_Used_Size_%" -Descending
    $reportHTML = $Warning | ConvertTo-Html -fragment
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $DatastoresFreeSpaceStatus = $header + $query_time + $reportHTML + " `n "
    $DatastoresFreeSpaceStatus | Out-File "$($tempPath)18.WARNINGDatastoresFreeSpaceStatusHTML.txt" -Force 
    Add-Content -path "$($tempPath)DatastoresFreeSpaceStatus.log" -value "INFORMATION, $(Get-Date) Finished DatastoresFreeSpaceStatus"
}
#endregion

#region Nutanix DataProtection Status
$NutanixDataProtectionStatus = {
    #Alert Titles
    #A1015 = Protection domain XXX replication failed
    #A1113 = Skipped Replication Of The Snapshot
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)NutanixDataProtectionStatus.log" -value "INFORMATION, $(Get-Date) Starting NutanixDataProtectionStatus"
    $PrismCentral = "ilprismcentral01.teva.corp"
    $ConnectToPrismCentral = $null
    $PDWithIssue = $null
    $ReplicationStatusArray = @()
    $myTimeZone=[System.TimeZoneInfo]::FindSystemTimeZoneById("Central European Standard Time")
    $cred = $null
    $i = 5       
    Do {
        Write-Host $i
        Start-Sleep 10
        $cred = CyberArkPAM -AccountID $vCentersDetails.($PrismCentral)
        $i--
    } While (($null -eq $cred) -and ($i -gt 0))
    try {
        $pass = ConvertTo-SecureString $cred.Password -AsPlainText -Force            
        $ConnectToPrismCentral = Connect-NutanixCluster -server $PrismCentral -UserName ($cred.Username) -Password $pass -AcceptInvalidSSLCerts -ForcedConnection
    }
    catch {
        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . serviceStatus: NutanixDataProtectionStatus : failed to connect to $PrismCentral"           
    }            
    ################################################
    # Building vCenter API string and invoking API
    ################################################
   
    if ($ConnectToPrismCentral) {
        $PDWithIssue = Get-NTNXAlert | Where-Object {($_.severity -eq 'kCritical') -and ($_.resolved -eq $false) -and (($_.alertTypeUuid -eq 'A1015') -or ($_.alertTypeUuid -eq 'A1113'))}
    }
    else {
        Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . NutanixDataProtectionStatus: failed to get credentials from PAM."
    }
    if ($null -ne $PDWithIssue) {
        foreach ($pd in $PDWithIssue) {
            $array = New-Object -TypeName PSObject
            $NutanixCluster = $null
            $ReplicationStatus = $null
            $ConnectToPrismElement = $null
            try {
                $NutanixCluster = Get-NTNXCluster -Id $pd.clusterUuid | Select-Object -Unique
            }
            catch {
                Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . NutanixDataProtectionStatus : failed to connect to NutanixCluster " $NutanixCluster.name
            }
            if ($NutanixCluster) {
                try {
                    $ConnectToPrismElement = Connect-NutanixCluster -server ($NutanixCluster.clusterExternalIPAddress).ToString() -UserName ($cred.Username) -Password $pass -AcceptInvalidSSLCerts -ForcedConnection
                }
                catch {
                    Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) . NutanixDataProtectionStatus : failed to connect to PrismElement " $NutanixCluster.clusterExternalIPAddress
                    continue
                }
                if ($ConnectToPrismElement) {
                    $NutanixCluster = Get-NutanixCluster -Servers $ConnectToPrismElement.Server
                    $ReplicationStatus = (Get-NTNXProtectionDomainReplication -NutanixClusters $NutanixCluster)
                    if ($pd.alertTypeUuid -eq 'A1015')
                    {
                        $array | Add-Member -Force -MemberType NoteProperty -Name "NTNX_Protection_Domain_Name" -Value $pd.contextValues[0] | Out-Null
                        $array | Add-Member -Force -MemberType NoteProperty -Name "NTNX_Protection_Domain_Status" -Value $pd.message
                        $array | Add-Member -Force -MemberType NoteProperty -Name "NTNX_Protection_Domain_Percentage_Completed" -Value "N/A"
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Alert_Create_time (Central European Standard Time)" -Value ([System.TimeZoneInfo]::ConvertTimeFromUtc((New-Object -Type DateTime -ArgumentList 1970, 1, 1, 0, 0, 0, 0).AddSeconds([math]::Floor($pd.createdTimeStampInUsecs/1000000)),$myTimeZone)).ToString()
                        $ReplicationStatusArray += $array
                    }
                    elseif ($null -eq $ReplicationStatus)
                    {
                        $array | Add-Member -Force -MemberType NoteProperty -Name "NTNX_Protection_Domain_Name" -Value $pd.contextValues[0]| Out-Null
                        $array | Add-Member -Force -MemberType NoteProperty -Name "NTNX_Protection_Domain_Status" -Value "No data found. There is no currently replication is progress. The replication was skiped or completed"
                        $array | Add-Member -Force -MemberType NoteProperty -Name "NTNX_Protection_Domain_Percentage_Completed" -Value "N/A"
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Alert_Create_time (Central European Standard Time)" -Value ([System.TimeZoneInfo]::ConvertTimeFromUtc((New-Object -Type DateTime -ArgumentList 1970, 1, 1, 0, 0, 0, 0).AddSeconds([math]::Floor($pd.createdTimeStampInUsecs/1000000)),$myTimeZone)).ToString()
                        $ReplicationStatusArray += $array
                        #$PDWithIssue.id | Resolve-NTNXAlert -ErrorAction SilentlyContinue
                    }
                    else
                    {
                        $array | Add-Member -Force -MemberType NoteProperty -Name "NTNX_Protection_Domain_Name" -Value $ReplicationStatus.protectionDomainName
                        $array | Add-Member -Force -MemberType NoteProperty -Name "NTNX_Protection_Domain_Status" -Value "Running"
                        $array | Add-Member -Force -MemberType NoteProperty -Name "NTNX_Protection_Domain_Percentage_Completed" -Value $ReplicationStatus.completedPercentage
                        $array | Add-Member -Force -MemberType NoteProperty -Name "Alert_Create_time (Central European Standard Time)" -Value ([System.TimeZoneInfo]::ConvertTimeFromUtc((New-Object -Type DateTime -ArgumentList 1970, 1, 1, 0, 0, 0, 0).AddSeconds([math]::Floor($pd.createdTimeStampInUsecs/1000000)),$myTimeZone)).ToString()
                        $ReplicationStatusArray += $array
                    }
                }
            }
        }
    } 

    $header="<p style=`"background-color:#4E8DC2;`"><b>Nutanix DataProtection Skipped Replications (check the Internet line bandwith)</b></p> `n"
    if (($null -eq $PDWithIssue) -and ($null -ne $ConnectToPrismCentral))
    {
        $ReplicationStatusArray = "All Protection Domains are successfully replicated."
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $NutanixDataProtectionStatusHTML = $header + $query_time + $ReplicationStatusArray + " `n "
        $NutanixDataProtectionStatusHTML | Out-File "$($tempPath)20.NutanixDataProtectionStatusHTML.txt" -Force 
    }
    else {
        $reportHTML = $ReplicationStatusArray | ConvertTo-Html -fragment
        $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
        $NutanixDataProtectionStatusHTML = $header + $query_time + $reportHTML + " `n "
        $NutanixDataProtectionStatusHTML | Out-File "$($tempPath)20.NutanixDataProtectionStatusHTML.txt" -Force 
    }
    Disconnect-NTNXCluster -Servers *
    Add-Content -path "$($tempPath)NutanixDataProtectionStatus.log" -value "INFORMATION, $(Get-Date) Finished NutanixDataProtectionStatus"
}
#endregion

#region vCenter failed logins Status
$vCenterFailedLogins = {
    $StartTimeMS = Get-Date -DisplayHint Time
    Set-Content -path "$($tempPath)vCenterFailedLogins.log" -value "INFORMATION, $(Get-Date) Starting vCenter Failed Logins"
    $FailedLoginEvents = @()
    foreach ($vcenter in $global:DefaultVIServers){
        $hostevents = Get-VIEvent -Server $vcenter -start (get-date).AddDays(-1) -finish (get-date) -maxsamples 100000
        $hostname = $null
        foreach ($event in $hostevents) {
            if ($event.fullFormattedMessage -match "Cannot login (.*)@(.*)") {
                $array = New-Object -TypeName PSObject
                $array | Add-Member -Force -MemberType NoteProperty -Name "vCenter" -Value $vcenter.name
                $array | Add-Member -Force -MemberType NoteProperty -Name "User" -Value $matches[1]
                $array | Add-Member -Force -MemberType NoteProperty -Name "Time" -Value $event.createdTime
                $array | Add-Member -Force -MemberType NoteProperty -Name "Destination Address" -Value $event.Host.Name
                try {
                    $hostname = (Resolve-DnsName $matches[2]).namehost
                }
                catch {
                    $hostname = $null
                }
                if ($hostname) {
                    #Write-Host ("User " + $matches[1] + " failed to login to " + $event.Host.Name + " from " + $hostname + " at: " + $event.createdTime)            
                    $array | Add-Member -Force -MemberType NoteProperty -Name "Source Address" -Value $hostname
                    $FailedLoginEvents += $array   
                }
                else {
                    #Write-Host ("User " + $matches[1] + " failed to login to " + $event.Host.Name + " from " + $matches[2] + " at: " + $event.createdTime)
                    $array | Add-Member -Force -MemberType NoteProperty -Name "Source Address" -Value $matches[2]
                    $FailedLoginEvents += $array   
                }
                
            }
        }
    }

    $FailedLoginEventsFinalReport = ($FailedLoginEvents | Sort-Object -Property "Destination Address" -Unique)
    $header="<p style=`"background-color:#4E8DC2;`"><b>Failed Logins Report last 24 hours</b></p> `n"
    $FailedLoginEventsReportHTML = $FailedLoginEventsFinalReport | ConvertTo-Html -fragment
    $query_time = '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'
    $FailedLoginEventsReport = $header + $query_time + $FailedLoginEventsReportHTML + " `n "
    $FailedLoginEventsReport | Out-File "$($tempPath)21.vCenterFailedLogins.txt" -Force
    Add-Content -path "$($tempPath)vCenterFailedLogins.log" -value "INFORMATION, $(Get-Date) Finished vCenter Failed Logins"
}
#endregion

#region Launch Queries
<#
$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $ssh.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name ssh -RunAs32
#>
$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $RunSnap.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name RunSnap -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $HostReport.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name HostReport -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $invalidvms.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name Invalidvms -RunAs32

#$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $vmsWithLimit.ToString())
#Start-Job -ScriptBlock $ScriptBlock -Name VMsWithLimit -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $functions.ToString() + "`n" + $serviceStatus.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name ServiceStatus -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $serviceStatusSRM.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name ServiceStatusSRM -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $serviceStatusZerto.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name serviceStatusZerto -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $ZertoVPGsStatus.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name ZertoVPGsStatus -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $checkHostAlarm.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name CheckHostAlarm -RunAs32

#$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $actionAlarmEnabled.ToString())
#Start-Job -ScriptBlock $ScriptBlock -Name ActionAlarmEnabled -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $SDReport.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name SDReport -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $RAMReport.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name RAMReport -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $OrphanedVMs.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name OrphanedVMs -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $functions.ToString() + "`n" + $VMStartPolicyCheck.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name VMStartPolicyCheck -RunAs32

#$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $functions.ToString() + "`n" + $VSANStatus.ToString())
#Start-Job -ScriptBlock $ScriptBlock -Name VSANStatus -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $functions.ToString() + "`n" + $CiscoIOVStatus.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name CiscoIOVStatus -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $functions.ToString() + "`n" + $ZeroUptime.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name ZeroUptime -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $functions.ToString() + "`n" + $VCSABackupsStatus.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name VCSABackupsStatus -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $ZertoVPGsDeleteEvents.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name ZertoVPGsDeleteEvents -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $functions.ToString() + "`n" + $PSCsHealthStatus.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name PSCsHealthStatus -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $functions.ToString() + "`n" + $DatastoresFreeSpaceStatus.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name DatastoresFreeSpaceStatus -RunAs32

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $functions.ToString() + "`n" + $NutanixDataProtectionStatus.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name NutanixDataProtectionStatus -RunAs32 -InitializationScript { Add-PSSnapin NutanixCmdletsPSSnapin }

$ScriptBlock = [ScriptBlock]::Create($parameters.ToString() + "`n" + $connect.ToString() + "`n" + $functions.ToString() + "`n" + $vCenterFailedLogins.ToString())
Start-Job -ScriptBlock $ScriptBlock -Name vCenterFailedLogins -RunAs32
#endregion

#region Wait before Cleanup
#Debug-Job -Job $Job
Get-Job | wait-job
Get-Job | Remove-Job
#endregion

#region Create Report 

$filegc=$null 
$files=Get-ChildItem -Path $tempPath |Where-Object{$_.name -like "*.txt"}
$fileout=""
$mytime=Get-Date
$mycheder="<p><b><font size=`"6`"> $mytime </font></b></p> `n" 
$mycheder=$mycheder + "<p><b><font size=`"6`"> VMware Health Check IL</font></b></p> `n" 
$fileout=$mycheder + '<p Style="font-family:Calibri">Total Querying Time: ' + $((Get-Date -DisplayHint Time) - $StartTimeMS) + '<br></p>'

if ($null -ne $files) 
{
    $files | ForEach-Object {
        $_.fullname
        $filegc=Get-Content $_.fullname
        $fileout =$fileout + $filegc + " `n "
    }
}

$fileout = convertto-html -body "$fileout" -head "<style> body {background-color: white; font-family:Calibri } table {background-color: #F5F5F5; margin: spx; float: left top: 0px; Display: inline-block; padding: spx; border: 1px solid black} tr:nth-child(odd) {background-color: lightgray } </style>"
$fileout | Out-File "$($tempPath)html1.html" -Force 

#endregion

#region Send Mail
$emailSmtpServer = "smtp.il.teva.corp"
$emailFrom = "GLVirtualization-VMWare-HealthCheck@tevapharm.com"
$emailTo = "glvirtualization@tevapharm.com"
$emailSubject = "Daily VMware Health Check v.2.4.7 IL - "+"$((get-date).ToShortDateString())"
$emailBody = $fileout
Send-MailMessage -To $emailTo -From $emailFrom -Subject $emailSubject -Body ($emailBody | out-string) -BodyAsHTML -SmtpServer $emailSmtpServer
#endregion

#region clean temp folder
#To avoid some situations where old information is presented as relevant
if (Test-Path $tempPath)
                {
		        get-childitem $tempPath -filter *.txt | Remove-Item
                get-childitem $tempPath -filter html1.html | Remove-Item
	            }
 Else
                {
                  Write-Host "Folder $TempPath does not exist or there is no access! Recheck the folder path in order to clean it"
                  Add-Content -path "$($tempPath)err.log" -value "ERROR, $(Get-Date) cannot connect to clean $TempPath, please check access permissions"
                }
#endregion

Disconnect-VIServer -Server * -Force -Confirm:$false -ErrorAction SilentlyContinue | Out-Null
exit
